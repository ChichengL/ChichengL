# 计算机网络

## 认识计算机网络

### 性能指标

1. 速率：速率即**数据率**或称**数据传输率**或比特率。			比特 1/0  位

连接在计算机网络上的主机在数字信道上传送数据**位数的速率**。		单位是b/s，kb/s，Mb/s，Gb/s，Tb/s

区分速率与存储容量：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206143034510.png" alt="image-20231206143034510" style="zoom:50%;" />



2. 带宽：“带宽”原本指某个信号具有的频带宽度，即最高频率与最低频率之差，单位是赫兹 (Hz)

计算机网络中，带宽用来表示网络的通信线路传送数据的能力，通常是指单位时间内从网络中的某一点到另一点所能通过的“最高数据率”。单位是“比特每秒”，b/s，kb/s，Mb/s，Gb/s

带宽存在的意义：类似于限制，也就是规定**网络设备所支持最高的速度**（限制的**发送速率**，传播速率与材料有关）

![image-20231206143631702](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206143631702.png)

3. 吞吐量：表示在**单位时间**内通过**某个网络(或信道、接口)**的数据量。单位b/s，kb/s，Mb/s等吞吐量受网络的带宽或网络的额定速率的限制。

![image-20231206143932684](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206143932684.png)



4. 时延：指数据(报文/分组/比特流)从网络(或链路)的一端传送到另一端所需的时间。也叫**延迟**或**迟延**。单位是s

    - 发送时延：从发送分组的第一个比特算起，到该分组的最后一个比特发送完毕所需的时间。 $发送时延 = 数据长度/{信道带宽（发送速率）}$
    - 传播时延：取决于电磁波的传播速度和链路长度    $传播时延=信道长度/{电磁波在信道上的传播速率}$
    - 排队时延：等待输出/入 链路可用
    - 处理时延：检错和找出口

    高速链路是指的**发送速率**提高

5. 时延带宽积：时延带宽积(bit) = 传播时延(s) * 带宽(bit/s)，也称为：以比特为单位的链路长度（即：某段链路现在有多少比特）

6. 往返时延RTT：从发送方发送数据开始（第一个比特位放在信道上），到发送方收到接收方的确认(接收方收到数据后立即发送确认，第一个比特位的确认)总共经历的时延。

    - RTT越大，在收到确认之前，可以发送的数据越多。
    - RTT包括：往返传播时延 = 传播时延*2，末端处理时间

7. 利用率：

    - 信道利用率 = $有数据通过时间/{(有+无)数据通过时间}$
    - 网络利用率 = 信道利用率加权平均值
    - ![image-20231206145512005](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206145512005.png)



### 体系结构和参考模型

分层结构：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206150524616.png" alt="image-20231206150524616" style="zoom:67%;" />

 ![image-20231206150952080](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206150952080.png)

![image-20231206151325390](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206151325390.png)





<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206151710368.png" alt="image-20231206151710368" style="zoom:50%;" />

#### OSI参考模型

为了解决计算机网络复杂的大问题 ，按功能分层

IBM公司第一个提出网络体系结构。

目的：支持异构网络系统的互联互通

ISO在1984年提出开放系统互联（OSI）参考模型，理论很成功，但是实际不行

![image-20231206152253421](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206152253421.png)

![image-20231206152759879](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206152759879.png)



1. 应用层：所有能和用户交互产生网络流量的程序

典型应用层服务：文件传输（FTP），电子邮件（SMTP），万维网（HTTP），...

2. 表示层：用于处理在两个通信系统中交换信息的表示方式(语法和语义）
    - 功能1：数据格式转化		`翻译官`
    - 功能2：数据加密和解密       
    - 功能3：数据的压缩和修复
3. 会话层：向表示层实体/用户进程提供**建立连接**并在连接上**有序**地**传输**数据
    - 也就是**建立同步**（SYN）
    - 功能1：建立、管理、终止会话
    - 功能2：使用检验点可以使会话在通信失效时，从**检验点/同步点**继续恢复通信，实现数据同步（适用于传输大文件）
4. 传输层：负责主机中**两个进程**的通信，即**端到端**的通信。传输单位是报文段或用户数据报
    - 功能1：**可**靠传输，不可靠传输
    - 功能2：**差**错控制
    - 功能3：**流**量控制
    - 功能4：复**用**分用：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206154124382.png" alt="image-20231206154124382" style="zoom:50%;" />
5. 网络层：主要任务是把**分组**从源端传到目的端，为分组交换网上的不同主机提供通信服务。网络层传输单位是**数据报**
    - 功能1：路由选择   		选择最佳路径
    - 功能2：流量控制           对发送端速度的一个控制
    - 功能3：差错控制           能纠错就纠错，不能直接丢弃
    - 功能4：拥塞控制           若所有结点都来不及接受分组，而要丢弃大量分组的话，网络就处于**拥塞**状态。因此要采取一定措施缓解这种拥塞
6. 数据链路层：主要任务是把网络层传下来的数据报**组装成帧**。数据链路层/链路层的传输单位是**帧**
    - 功能1：成帧（定义帧的开始和结束 ）
    - 功能2：差错控制   **帧错+位错**
    - 功能3：流量控制
    - 功能4：访问（接入）控制    **控制对信道的访问**
7. 物理层：主要任务是在**物理媒体**上实现比特流的**透明传输**   传输单位是**比特**
    - 透明传输：不管所传数据是什么类型的比特组合，都应该能够在链路上传送
    - 功能1：定义接口特性
    - 功能2：定义传输模式				单工（一人作为发送方，一人作为接收方），半双工（两个人都可以作为发送方和接收方，但是同一时间只能有一个人），双工（类似于打电话，双方可以同时说话或者接收对面的信息）
    - 功能3：定义传输速率
    - 功能4：比特同步
    - 功能5：比特编码

#### TCP/IP参考模型

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206155625045.png" alt="image-20231206155625045" style="zoom:50%;" /><img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206155645255.png" alt="image-20231206155645255" style="zoom:50%;" />

OSI和TCP/IP的相同点

1. 都分层
2. 基于独立的协议栈的概念
3. 可以实现异构网络互联

不同

1. OSI定义三点：协议，服务，接口
2. OSI先出现，参考模型先于协议发明，不偏向特定协议
3. TCP/IP设计之初就考虑到异构网**互联**的问题，将IP作为重要层次
4. <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206160116875.png" alt="image-20231206160116875" style="zoom:50%;" />

5层参考模型

综合了OSI和TCP/IP的优点

![image-20231206160346464](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231206160346464.png)



![image-20231217182748920](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217182748920.png)

![image-20231217182800002](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217182800002.png)

![image-20231217182811533](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217182811533.png)

![image-20231217182822800](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217182822800.png)

**协议**是控制两个对等实体在“**水平方向**”进行“**逻辑通信**”的**规则**的集合

协议的三要素
**语法**   定义所交换信息的格式
**语义** 定义通信双方所要完成的操作
**同步**  定义通信双方的时序关系

协议是“水平”的，而服务是“垂直”的。

实体看得见下层提供的服务，但并不知道实现该服务的具体协议。**下层的协议对上层的实体是“透明”的**



## 物理层

物理层接口特性

![image-20231217183334377](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183334377.png)

传输媒体的分类

![image-20231217183312301](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183312301.png)

### 导向型传输媒体

![image-20231217183451990](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183451990.png)

![image-20231217183515494](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183515494.png)

![image-20231217183603121](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183603121.png)

对于曼彻斯特编码

**有向下走为1，有向上走为0**（看的是中间）



对于差分曼彻斯特编码

对于一个比特的起始，如果有变化则为0，没变化则为1

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183823723.png" alt="image-20231217183823723" style="zoom: 80%;" />![image-20231217183925848](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183925848.png)

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183823723.png" alt="image-20231217183823723" style="zoom: 80%;" />![image-20231217183925848](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217183925848.png)

曼彻斯特编码例题

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184049957.png" alt="image-20231217184049957" style="zoom: 67%;" />

差分曼彻斯特编码例题

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184132917.png" alt="image-20231217184132917" style="zoom:67%;" />



### 信道干扰

信道失真

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184207096.png" alt="image-20231217184207096" style="zoom:50%;" />

主要因素

1. 信道上传输的**数字信号**，可以看做是**多个频率的模拟信号进行多次叠加后形成的方波**
2. 如果数字信号中的高频分量在传输时受到衰减甚至不能通过信道，则接收端接收到的波形前沿和后沿
    就变得不那么陡峭，每一个码元所占的时间界限也不再明确。这样，在接收端接收到的信号波形就**失**
    **去了码元之间的清晰界限**，这种现象称为**码间串扰**。
3. 如果信道的**频带越宽**，则能够**通过的信号的高频分量就越多**，那么码元的**传输速率就可以更高**，而**不**
    **会导致码间串扰。**
4. 然而，**信道的频率带宽是有上限的**，不可能无限大。因此，**码元的传输速率也有上限**

为了计算达到某值后失真率骤降

奈氏准则

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184512980.png" alt="image-20231217184512980" style="zoom:67%;" />

香农公式：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184550308.png" alt="image-20231217184550308" style="zoom:67%;" />

**带宽受限**且有**高斯白噪声**干扰的信道的**极限信息传输速率**

- 信道的频率带宽W或信道中的信噪比S/N越大，信道的极限信息传输速率C就越高
- 实际信道不可能无限制地提高频率带宽W或信道中的信噪比S/N
- 实际信道中能够达到的信息传输速率，要比香农公式给出的极限传输速率低不少
    这是因为在实际信道中，信号还要受到其他一些损伤，例如各种脉冲干扰和信号衰
    减等，这些因素在香农公式中并未考虑

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184847586.png" alt="image-20231217184847586" style="zoom:67%;" />

![image-20231217184921013](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217184921013.png)



### 信道复用

基本原理

复用 (Multiplexing)就**是在一条传输媒体上同时传输多路用户的信号**

当一条传输媒体的传输容量大于多条信道传输的总容量时，就可以通过复用技术，在这条传输媒体上建立多条通信信道，以便**充分利用传输媒体的带宽。**

尽管实现信道复用会增加通信成本(需要复用器、分用器以及费用较高的大容量共享信道)，但如果**复用的信道数量较大**，**还是比较划算的。**



常见技术：

- 频分复用FDM
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185205895.png" alt="image-20231217185205895" style="zoom:67%;" />
- 时分复用TDM
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185249814.png" alt="image-20231217185249814" style="zoom:67%;" />
    - 类似于时间片轮转
- 波分复用WDM
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185337203.png" alt="image-20231217185337203" style="zoom:67%;" />
- **码分复用CDM**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185425949.png" alt="image-20231217185425949" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185445996.png" alt="image-20231217185445996" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185458900.png" alt="image-20231217185458900" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185525266.png" alt="image-20231217185525266" style="zoom:67%;" />
    - 当内积不为0时，说明是个该设备发送信息
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185624376.png" alt="image-20231217185624376" style="zoom:67%;" />
    - 



## 数据链路层

链路(Link)是指从一个节点到相邻节点的一段物理线路(有线或无线)，**而中间没有任何其他的交换节点。**

数据链路(Data Link)是基于链路的。当在一条链路上传送数据时，除需要链路本身，还需要一些必要的通信协议来控制这些数据的传输，把**实现这些协议的硬件和软件加到链路上**，就构成了数据链路。

计算机中的网络适配器(俗称**网卡**)和其相应的**软件驱动程序**就实现了这些协议。**一般的网络适配器都包含了物理层和数据链路层这两层的功能。**

### 三个重要问题



1. 封装成帧和透明传输<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185739600.png" alt="image-20231217185739600" style="zoom:67%;" />![image-20231217185800770](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185800770.png)
2. 差错检查<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185842499.png" alt="image-20231217185842499" style="zoom:67%;" />
3. 可靠传输<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217185859398.png" alt="image-20231217185859398" style="zoom:67%;" />



### 封装成帧和透明传输

**封装成帧**是指数据链路层给上层交付下来的协议数据单元PDU添加一个首部和一个尾部，使之成为帧

- 帧的首部和尾部中包含有一些**重要的控制信息**
- 帧首部和尾部的作用之一就是**帧定界**。
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217190209375.png" alt="image-20231217190209375" style="zoom:67%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217190236989.png" alt="image-20231217190236989" style="zoom:67%;" />



**透明传输**

透明传输是指**数据链路层对上层交付下来的协议数据单元PDU没有任何限制**，就好像数据链路层不存在一样。

- 面向**字节**的物理链路使用**字节填充**的方法实现透明传输
- 面向**比特**的物理链路使用**比特填充**的方法实现透明传输。

![image-20231217190606395](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217190606395.png)

传输时，在连续5个1后面添加一个0，后面接受到消息在进行删除

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217190703956.png" alt="image-20231217190703956" style="zoom:67%;" />

或者在出现帧首部/尾部的标识的帧中间插入一个转义字符，防止帧的提前结束





### 差错检查

误码：实际的通信链路都不是理想的，比特在传输过程中可能会产生差错(称为**比特差错)**

- 比特1可能变成比特0
- 比特0可能变成比特1

在一段时间内，传输错误的比特数量占所传输比特总数的比率称为**误码率** (Bit Error Rate，BER)

**提高链路的信噪比**，可以**降低误码率**。但在实际的通信链路上，**不可能使误码率下降为零**

使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

使用**差错检测技术**来检测数据在传输过程中是否产生了比特差错，是数据链路层所要解决的重要问题之一。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191100696.png" alt="image-20231217191100696" style="zoom:67%;" />

**奇偶校验**：

- 奇校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中**比特1的个数为奇数**
- 偶校验是在待发送的数据后面添加1个校验位，使得添加该校验位后的整个数据中**比特1的个数为偶数**
- 缺点：如果出现多次差错，将无法检查出来
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191247622.png" alt="image-20231217191247622" style="zoom:50%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191303713.png" alt="image-20231217191303713" style="zoom:67%;" />

**循环冗余校验**

发送方<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191446563.png" alt="image-20231217191446563" style="zoom:67%;" />

接收方：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191507539.png" alt="image-20231217191507539" style="zoom:67%;" />

生成多项式：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191551067.png" alt="image-20231217191551067" style="zoom: 67%;" />

发送<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191733877.png" alt="image-20231217191733877" style="zoom:67%;" />

接收<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191802927.png" alt="image-20231217191802927" style="zoom:67%;" />

总结：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191843853.png" alt="image-20231217191843853" style="zoom:67%;" />



### 可靠传输

基本概念：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217191944603.png" alt="image-20231217191944603" style="zoom: 67%;" />

传输差错：

- 误码：和上一节内容一同
- 分组丢失：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192149914.png" alt="image-20231217192149914" style="zoom:67%;" />
- 分组失序：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192220868.png" alt="image-20231217192220868" style="zoom:67%;" />开始是绿紫橙
- 分组重复：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192305444.png" alt="image-20231217192305444" style="zoom:67%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192318948.png" alt="image-20231217192318948" style="zoom:67%;" />误码主要存在在数据链路层和物理层

**可靠传输服务并不局限于数据链路层**，其他各层均可选择实现可靠传输

可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192435347.png" alt="image-20231217192435347" style="zoom:67%;" />

比如运输层的tcp可靠传输

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192541480.png" alt="image-20231217192541480" style="zoom:67%;" />

#### 可靠传输的三种协议

- 停止等待协议：
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192703325.png" alt="image-20231217192703325" style="zoom:67%;" />
    - 超时重传：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192734092.png" alt="image-20231217192734092" style="zoom:67%;" />
    - 分组编号（都要）<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192750046.png" alt="image-20231217192750046" style="zoom:67%;" />防止不知道哪个是否成功传入<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217192918522.png" alt="image-20231217192918522" style="zoom:67%;" />
    - 注意事项：
        - 使用超时重传机制后，就可以不使用否认机制了，这样可使协议实现起来更加简单。但是，如果点对点链路的误码率较高，**使用否认机制可以使发送方在超时计时器超时前就尽快重传。**
        - 为了让接收方能够判断所收到的数据分组是否是重复的，需要给**数据分组编号**。由于**停止-等待协议**的特性，**只需1个比特编序号即可**，即序号0和序号1。
        - 为了让发送方能够判断所收到的确认分组是否是重复的，需要给**确认分组编号**，所用比特数量**与数据分组所用比特数量一样。**
        - 数据链路层一般不会出现确认分组迟到的情况，因此在**数据链路层实现停止-等待协议可以不用给确认分组编号。**
        - 给超时计时器设置的超时重传时间RTO应当仔细选择，**一般将RTO设置为略大于收发双方的平均往返时间RTT**。
        - 在数据链路层，点对点的往返时间RTT比较固定，RTO就比较好设定。
        - 在运输层，由于端到端往返时间非常不确定，设置合适的超时重传时间RTO有时并不容易停止-等待协议属于自动请求重传 (Automatic Repeat reQuest，**ARQ**)协议。即重传的请求是发送方自动进行的，而不是接收方请求发送方重传某个误码的数据分组。
    - 信道利用率：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193220320.png" alt="image-20231217193220320" style="zoom:67%;" /><img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193446108.png" alt="image-20231217193446108" style="zoom:67%;" />
- 回退N帧协议：使用滑动窗口
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193540713.png" alt="image-20231217193540713" style="zoom: 67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193710911.png" alt="image-20231217193710911" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193844889.png" alt="image-20231217193844889" style="zoom:67%;" />
    - 累积确认![image-20231217193928844](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217193928844.png)比如只接受到0,3的确认ACK分组，那么就认为3组及其之前的所有分组就已经确认了
- 选择重传协议：
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194131898.png" alt="image-20231217194131898" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194256524.png" alt="image-20231217194256524" style="zoom:67%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194322714.png" alt="image-20231217194322714" style="zoom:67%;" />为了使发送方仅重传出现差错的数据分组接收方**不再采用累积确认**，而需要对每一个正确接收的数据分组进行**逐一确认**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194505486.png" alt="image-20231217194505486" style="zoom:67%;" />选择重传，重传的是没接收到确认分组的
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194545723.png" alt="image-20231217194545723" style="zoom: 67%;" />回退N帧要重传多个

### 点对点协议（Point Point Protocol）

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194637477.png" alt="image-20231217194637477" style="zoom:67%;" />

帧格式：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194813210.png" alt="image-20231217194813210" style="zoom:67%;" />

点对点的透明传输：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194829664.png" alt="image-20231217194829664" style="zoom:67%;" />

差错检查：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194855003.png" alt="image-20231217194855003" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194923243.png" alt="image-20231217194923243" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217194944978.png" alt="image-20231217194944978" style="zoom:67%;" />



### 网络适配器和mac地址

网络适配器：功能：要将计算机连接到以太网，需要使用相应的**网络适配器** (Adapter)，网络适配器一般简称为“**网卡**”

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217200305051.png" alt="image-20231217200305051" style="zoom:67%;" />

- 在计算机内部，**网卡与CPU**之间的通信，一般是通过计算机主板上的1/0总线以**并行传输**方式进行。
- **网卡与外部以太网 (局域网)**之间的通信，一般是通过传输媒体(同轴电缆、双绞线电缆、光纤)以**串行方式**进行的。
- 网卡除要实现**物理层和数据链路层功能**，其另外一个重要功能就是要**进行并行传输和串行传输的转换**由于网络的传输速率和计算机内部总线上的传输速率并不相同，因此在网卡的核心芯片中都会包含用于缓存数据的存储器。
- 在确保网卡硬件正确的情况下，为了使网卡正常工作，还必须要在计算机的操作系统中为网卡安装柜应的设备驱动程序。**驱动程序**负责驱动网卡发送和接收帧

mac地址：

- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个**唯一的标识**，即一个**数据链路层地址**。
- 在每个主机发送的**帧的首部**中，都**携带**有发送主机(源主机)和接收主机(目的主机)的**数据链路层地址**。由于这类地址是用于**媒体接入控制** (**M**edium **A**ccess Control，**M**AC)的，因此被称为**MAC地址**
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217200637854.png" alt="image-20231217200637854" style="zoom:67%;" />
- 一般情况下，普通用户计算机中往往会包含两块网卡
    - 一块是用于接入有线局域网的**以太网卡**
    - 另一块是用于接入无线局域网的**Wi-Fi网卡**
- 每块网卡都有一个**全球唯一的MAC地址**
- 交换机和路由器往往具有更多的网络接口，所以会拥有更多的MAC地址
- 综上所述，严格来说，MAC地址是对网络上**各接口**的唯一标识而不是对网络上各设备的唯一标识。
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217200822462.png" alt="image-20231217200822462" style="zoom:67%;" />6位，5个**-**
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217200919613.png" alt="image-20231217200919613" style="zoom:67%;" />
- 单播mac<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217201001240.png" alt="image-20231217201001240" style="zoom:67%;" />
- 广播mac<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217201023336.png" alt="image-20231217201023336" style="zoom:67%;" />目的地址FF-FF-FF-FF-FF-FF代表向一切都发送
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217201107843.png" alt="image-20231217201107843" style="zoom:67%;" />



### 共享式以太网

#### CSMA/CD协议的基本原理

当某个站点在总线上发送帧时总线资源会被该站点独占。此时，如果总线上的其他站点也要在总线上发送帧，就会产生**信号碰撞**

当两个或多个站点同时使用总线发送帧时，就会产生信号碰撞

例如：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217202220509.png" alt="image-20231217202220509" style="zoom:67%;" />

共享总线以太网的一个重要问题: **如何协调总线上的各站点争用总线**

因此引入CSMA/CD协议

![image-20231217202419149](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217202419149.png)

先听再发，变发边听，冲突停止，随机退让，重新再发

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217202618932.png" alt="image-20231217202618932" style="zoom:67%;" />

强化碰撞：发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送**32比特或48比特的人为干扰信号**(Jamming Signal)，以便**有足够多的碰撞信号使所有站点都能检测出碰撞**

载波监听检测到总线空闲，但**总线并不一定空闲**		比如b发完消息，c立即检测，检测到没有“没有发送消息”，然后c也开始发送消息

使用CSMA/CD协议的共享总线以太网上的各站点，只是尽量避免碰撞并在出现碰撞时做出退避后重发的处理，但**不能完全避免碰撞。**

在使用CSMA/CD协议时，由于正在发送帧的站点必须“边发送边检测碰撞”，因此站点不可能同时进行发送和接收，也就是不可能进行全双工通信，而只能进行**半双工通信**(双向交替通信)。



#### 共享式以太网的争用期

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217212924972.png" alt="image-20231217212924972" style="zoom:67%;" />

某个站点从发送帧开始，最长要经过多长时间，才能检测出自己发送的帧与其他站点发送的帧产生了碰撞?

是从极端情况考虑<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231217213150478.png" alt="image-20231217213150478" style="zoom: 50%;" />

站点从发送帧开始，最多经过时长**2$\tau$ (即$\delta$ -0)**就可测出所发送的是否遭遇了碰撞

因此，共享总线以太网的**端到端往返时间2$\tau$**被称为**争用期** (Contention Period)或**碰撞窗口** (CollisionWindow)，它是一个非常重要的参数。

站点从发送帧开始，**经过争用期2t这段时间还没有检测到碰撞，就可以肯定这次发送不会产生碰撞**

从争用期的概念可以看出，共享总线以太网上的每一个站点从发送帧开始，到之后的一小段时间内，都有可能遭遇碰撞，而**这一小段时间的长短是不确定的**，它取决于**另一个发送帧的站点与本站点的距离**,但不会超过总线的端到端往返传播时延，即一个争用期2$\tau$。

很显然,总线的长度越长(单程端到端传播时延越大)，，网络中站点数量越多，发生碰撞的概率就越大

因此，共享以太网的总线长度不能太长，接入的站点数量也不能太多



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218090244834.png" alt="image-20231218090244834" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218091016282.png" alt="image-20231218091016282" style="zoom:50%;" />



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218091153732.png" alt="image-20231218091153732" style="zoom:67%;" />

为了确保共享总线以太网上的每一个站点在发送完一个完整的帧之前，能够检测出是否产生了碰撞,**帧的发送时延就不能少于共享总线以太网端到端的往返时间**，即一个争用期2$\tau$。

对于10Mb/s的共享总线以太网，其争用期2t 的值规定为51.2us，因此其最小长为512b，即64B

计算：最小长度 = 速度 * 时间。即   b = 10Mb/s * 51.2us           b = 512b

当某个站点在发送帧时如果帧的前64B没有遭遇碰撞，那么帧的后续部分也就不会遭遇碰撞。也就是说，如果遭遇碰撞，就一定是在帧的前64B之内。

由于发送帧的站点边发送帧边检测碰撞，一旦检测到碰撞就立即中止帧的发送，此时已发送的数据量一定小于64B。因此，接收站点收到**长度小于64B的帧**，就可判定这是一个**遭遇了碰撞而异常中止的无效帧**，将其丢弃即可。

一般来说，**帧的数据载荷的长度应远大于帧首部和尾部的总长度**，这样可以**提高帧的传输效率**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218092028052.png" alt="image-20231218092028052" style="zoom:67%;" />

最大小帧长<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218092109921.png" alt="image-20231218092109921" style="zoom:67%;" />

例题

![image-20231218092341820](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218092341820.png)



#### 共享式以太网的退避算法和信道利用率

在使用CSMA/CD协议的共享总线以太网中，正在发送顿的站点一边发送帧一边检测碰撞，当检测到碰撞时就立即停止发送，退避**一段随机时间**后再重新发送

共享总线以太网中的各站点采用**截断二进制指数退避 (Truncated Binary Exponential Backoff) 算法**来选择退避的随机时间。



![image-20231218125704623](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218125704623.png)

如果连续多次发生碰撞，就表明可能有较多的站点参与竞争信道。但使用上述退避算法可使**重传需要推迟的平均时间随重传次数而增大** (即**动态退避**)，因而**减小产生碰撞的概率**

当**重传达16次仍不能成功**时，就表明同时打算发送帧的站点太多，以至于连续产生碰撞，此时**应放弃重传**并向高层报告。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218131932327.png" alt="image-20231218131932327" style="zoom:67%;" />

**利用率：**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218132058629.png" alt="image-20231218132058629" style="zoom:67%;" />

$\tau$是端到端的时间

例题：

![image-20231218132323291](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218132323291.png)



#### 使用集线器的共享式以太网

早期的传统以太网是使用**粗同轴电缆**的共享**总线**以太网，后来发展到使用价格相对便宜的**细同轴电缆**

当初认为这种连接方法既简单又可靠，因为在那个时代普遍认为**有源器件不可靠**，而**无源的电缆线才是最可靠的**。

然而，实践证明这种使用**无源电缆线和大量机械接口**的总线型以太网**并不**像人们想象的那么**可靠**

![image-20231218132627712](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218132627712.png)

在使用细同轴电缆的共享总线以太网之后，以太网发展出来了一种使用大规模集成电路来替代总线、并且可靠性非常高的设备，叫作**集线器 (Hub)**

站点连接到集线器的传输媒体也转而使用更便宜、更灵活的**双绞线电缆**。

集线器的特点：

- 使用集线器的以太网虽然**物理拓扑是星型的**，但在**逻辑**上仍然是一个**总线网**。总线上的各站点共享总线资源，使用的还是**CSMA/CD**协议。
- 集线器**只工作在物理层**，它的每个接口仅简单地转发比特，并不进行碰撞检测。碰撞检测的任务由各站点中的网卡负责。
- 集线器一般都**有少量的容错能力和网络管理功能**例如，若网络中某个站点的网卡出现了故障而不停地发送帧，集线器可以检测到这问题，在内部断开与出故障网卡的连线，使整个以太网能正常工作.
- ![image-20231218133012595](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218133012595.png)
- IEEE于1990年制定了**10BASE-T**星型以太网的标准802.3i，这种以太网是局域网发展史上的一座非常重要的里程碑，它为**以太网在局域网中的统治地位**奠定了牢固的基础。
- 10BASE-T以太网的通信距离较短，每个**站点到集线器的距离不能超过100m**。
- IEEE 802.3以太网还可使用光纤作为传输媒体，相应的标准为10BASEF，“F”表示光纤。光纤主要用作集线器之间的远程连接。
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218133200024.png" alt="image-20231218133200024" style="zoom:67%;" />







#### 物理层扩展以太网

共享总线以太网中两站点之间的**距离不能太远**，否则它们之间所传输的**信号就会衰减到使CSMA/CD协议无法正常工作**。

在早期广泛使用粗同轴电缆或细同轴电缆共享总线以太网时，为了提高网络的地理覆盖范围，常用的是**工作在物理层的转发器**

IEEE 802.3标准规定，两个网段可用一个转发器连接起来，任意两个站点之间最多可以经过三个网段

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218134436868.png" alt="image-20231218134436868" style="zoom:67%;" />



在10BASE-T星型以太网中，可使用**光纤**和一对光**纤调制解调器**来**扩展站点与集线器之间的距离**——————这种扩展方法比较简单，所需付出的代价是:为站点和集线器各增加一个用于电信号和光信号转换的光纤调制解调器，以及它们之间的一对通信光纤

信号在光纤中的衰减和失真很小，因此使用这种方法可以很简单地将站点与集线器之间的距离扩展到1000m以上

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218134745689.png" alt="image-20231218134745689" style="zoom:67%;" />



以太网集线器一般具有8~32个接口，如果要连接的站点数量超过了单个集线器能够提供的接口数量，就需要使用多个集线器，这样就可以连接成覆盖更大范围、连接更多站点的多级星型以太网。

采用多个集线器连接而成的多级星型以太网，在扩展了网络覆盖范围和站点数量的同时，也带来了一些负面因素。

负面：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218135027031.png" alt="image-20231218135027031" style="zoom:50%;" />



### 在数据链路层扩展以太网

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218135230240.png" alt="image-20231218135230240" style="zoom:50%;" />

网桥(bridge)工作在数据链路层(包含其下的物理层)，因此**网桥具备属于数据链路层范畴的相关能力**

网桥可以**识别帧的结构.**

网桥可以根据帧首部中的**目的MAC地址**和网桥自身的**帧转发表**来转发或丢弃所收到的帧

![image-20231218135844248](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218135844248.png)

![image-20231218135953702](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218135953702.png)



![image-20231218140101480](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231218140101480.png)



透明网桥的自学习

![image-20231219164731403](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219164731403.png)

透明网桥(Transparent Bridge)通过**自学习**算法建立转发表

透明网桥中的**“透明”**，是指以太网中的各站点并不知道自己所发送的帧将会经过哪些网桥的转发，最终到达目的站点。也就是说，**以太网中的各网桥对于各站点而言是看不见的**

透明网桥的标准是IEEE 802.1D，它通过一种自学习算法**基于以太网中各站点间的相互通信**逐步建立起自己的转发表。

![image-20231219165209931](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219165209931.png)

地址是来自于哪里

网桥收到帧后进行**登记 (即自学习)**，登记的内容为的**源MAC地址**和进入网桥的**接口号**

网桥根据帧的**目的MAC地址**和网桥的**转发表**对帧进行**转发**，包含以下三种情况:

- **明确转发**: 网桥知道应当从哪个接口转发帧
- **盲目转发**：网桥不知道应当从哪个接口转发帧，只能将其通过除进入网桥的接口外的其他所有接口转发
- **丢弃**:网桥知道不应该转发该帧，将其丢弃

![image-20231219165440315](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219165440315.png)



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219165453759.png" alt="image-20231219165453759" style="zoom:67%;" />



为了提高以太网的**可靠性**，有时需要在两个以太网之间使用多个透明网桥来提供**冗余链路.**

在增加冗余链路提高以太网可靠性的同时，却给网络引入了**环路**

网络中的**广播帧将在环路中永久兜圈**，造成广播帧充斥整个网络，**网络资源被白白浪费**，而网络中的主机之间无法正常通信

为了避免广播帧在环路中永久兜圈，透明网桥使用**生成树协议**Spanning Tree Protocol，STP) ，可以在增加冗余链路提高网络可靠性的同时，又避免环路带来的问题

- 不管网桥之间连接成了怎样复杂的带环拓扑，网桥之间通过**交互网桥协议单元** (Bridge Protocol DataUnit，BPDU)，**找出原网络拓扑的一个连通子集** (即生成树)，在这个子集里整个连通的网络中**不存在环路**。
- 当首次连接网桥或网络拓扑发生变化时(人为改变或出现故障)网桥都会重新构造生成树，以确保网络的连通。
- ![image-20231219165839007](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219165839007.png)





### 交换式以太网

网桥的**接口数量很少**，通常只有2~4个，一般只用来**连接不同的网段**

1990年面世的**交换式集线器**(Switching Hub)，实质上是**具有多个接口的网桥**，常称为**以太网交换机**(Switch)或二层交换机

- “二层”是指以太网交换机工作在数据链路层(包括物理层)
-  与网桥相同，交换机内部的转发表也是通过自学习算法，基于网络中各主机间的通信，自动地逐步建立起来的.
- 另外，交换机也使用生成树协议STP，来产生能够连通全网但不产生环路的通信路径。
- 仅使用交换机(而不使用集线器)的以太网就是交换式以太网。



![image-20231219170057030](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219170057030.png)



### 以太网交换机

交换机的每个接口可以连接**计算机**，也可以连接**集线器**或另一个**交换机**

当交换机的**接口与计算机或交换机连接**时，可以工作在**全双工方式**，并能**在自身内部同时连通多对接口**，使每一对相互通信的计算机都能像独占传输媒体那样，无碰撞地传输数据，这样就**不需要使用CSMA/CD协议了**。

![image-20231219171355018](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219171355018.png)



例题2：

![image-20231219171543544](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219171543544.png)

![image-20231219171615729](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219171615729.png)

因为发送传送帧时，没有3的mac地址，那么就会进行盲目转发，因此转发到{2,3}端口

以太网交换机进行转发决策时使用的PDU地址是 **目的物理地址，即目的mac地址**

一般的交换机都采用“**存储转发**”方式，为了减小交换机的转发时延，某些交换机采用了**直通** (Cut-Through)交换方式

采用**直通交换方式**的交换机，在**接收帧的同时就立即按帧的目的MAC地址决定该帧的转发接口**，然后通过其内部**基于硬件的交叉矩阵**进行转发，而不必把整个帧先缓存后再进行处理。

直通交换的**时延非常小**

直通交换**不检查差错就直接将帧转发出去**，有可能会将一些无效帧转发给其他主机。

![image-20231219172446053](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219172446053.png)





### 共享式以太网和交换式以太网的对比

对于单播转发：

![image-20231219172706459](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219172706459.png)

对于广播帧![image-20231219172911916](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219172911916.png)

他们俩都属于同一广播域，但是实际上实现原理不同。

集线器是工作在物理层，因此不能识别帧的目的mac地址。集线器对单播帧和广播帧待遇相同，向所有接口转发他们

交换机工作在数据链路层，能识别帧的结构，根据查找结果，对帧进行明确转发或盲目转发或丢弃

集线器不隔离冲突域和广播域，交换机可以隔离冲突域，但是不隔离广播域

![image-20231219173319061](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219173319061.png)

集线器：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219173611473.png" alt="image-20231219173611473" style="zoom:50%;" />



交换机：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219173648103.png" alt="image-20231219173648103" style="zoom:50%;" />

例题1![image-20231219174024959](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219174024959.png)

例题2：

![image-20231219174319025](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219174319025.png)



交换式以太网的网络性能远高于共享式以太网，集线器早已被交换机取代







### 以太网的mac帧格式



![image-20231219175100386](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219175100386.png)



类型：其值用来指明数据载荷中的内容是由上一层的哪个协议封装的以便将收到的MAC帧的数据载荷上交给上一层的这个协议。

目的地址和源地址：分别装入的是目的地址的mac地址和源地址的mac地址。

![image-20231219175427779](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231219175427779.png)

FCS：使用**CRC**（循环冗余算法）生成的帧检验序列FCS，接收方的网卡通过FCS的内容就**可检测**出帧在传输过程中是否产生了**误码**。





## 网络层

### 概述

![image-20231222121301824](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121301824.png)

网络层的主要任务就是将**分组从源主机经过多个网络和多段链路传输到目的主机**，可以将该任务划分为**分组转发**和*路由选择*两种重要的功能

![image-20231222121430238](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121430238.png)

网络层向其上层提供的两种服务

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121546492.png" alt="image-20231222121546492" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121613080.png" alt="image-20231222121613080" style="zoom:67%;" />

不可靠，尽最大努力交付

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121648542.png" alt="image-20231222121648542" style="zoom: 67%;" />

- 核心思想是“*可靠通信应由网络自身来保证*“
- 必须首先*建立网络层连接 - 虚电路*(Virtual Circuit，VC)，以保证通信双方所需的一切网络资源.
- 通信双方*沿着已建立的虚电路发送分组*
- 通信结束后，需要**释放**之前所建立的虚电路
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222121828364.png" alt="image-20231222121828364" style="zoom: 67%;" />
- 

### IPv4

#### 网际协议ip和异构

网际协议 (Internet Protocol，IP)是TCP/IP体系结构*网际层中的核心协议*

网际协议IP、传输控制协议TCP、TCP/IP体系结构是由“**因特网之父**”Robert Kahn和Vint Cerf二人共同研发
的，1974年5月发布了TCP/IP的第一个版本

TCP/IP体系结构

![image-20231222122103206](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222122103206.png)

异构网络

![image-20231222122121993](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222122121993.png)

- 这些网络的拓扑、性能以及所使用的网络协议都不尽相同，这是由用户需求的多样性造成的，没有一种单一的网络能够适应所有用户的需求。
- 要将众多的异构型网络都互连起来，并且能够互相通信，则会面临许多需要解决的问题
- 不同的网络接入机制
    不同的差错恢复方法
    不同的路由选择技术
    不同的寻址方案
    不同的最大分组长度
    不同的服务(面向连接服务和无连接服务)

#### IPV4地址及编址方法

##### 概述

IPv4地址是给因特网(lnternet) 上的*每一个主机 (或路由器)的每一个接口*分配的一个在全世界范围内*唯一的32比特的标识符*

IPv4地址由**因特网名字和数字分配机构 (lnternet Corporation for Assigned Names and Numbers，ICANN**)进行分配。

我国用户可向**亚太网络信息中心** (Asia Pacific Network nformation Center，APNIC)申请IP地址，需要缴纳相应的费用，一般不接受个人申请。

**2011年2月3日，因特网号码分配管理局**(Internet Assigned Numbers Authority，IANA) (由ICANN行使职能)宣布，*IPv4地址已经分配完毕*

我国在2014至2015年也逐步停止了向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6.

表示方法：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222122441990.png" alt="image-20231222122441990" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222122455728.png" alt="image-20231222122455728" style="zoom:67%;" />

三个历史阶段

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222122520618.png" alt="image-20231222122520618" style="zoom:50%;" />



##### 分类编址



分为网络号和主机号，两者的长度并非固定

网络号

- 标志主机(或路由器)的接口所连接到的*网络*
- *同一个网络*中，*不同*主机 (或路由器)的*接口*的IPv4地址的*网络号必须相同*，表示它们属于同一个网络。

主机号

- 标志主机(或路由器)的*接口*
- *同一个网络中*，*不同主机* (或路由器)的*接口*的IPv4地址的*主机号必须各不相同*，以便区分各主机(或路由器)的接口。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222123100693.png" alt="image-20231222123100693" style="zoom:50%;" />

主要是A，B，C类

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222123126287.png" alt="image-20231222123126287" style="zoom:67%;" />

A类（网络1位，主机3位,范围1.0.0.0~126.255.255.254）

- 最小网络号为0，表示本网络，不能指派;
- 最小可指派的网络号为1，网络地址为1.0.0.0
- 最大网络号为127，作为本地环回测试地址，不能指派
    - 最小的本地环回测试地址为127.0.0.1
    - 最大的本地环回测试地址为127.255.255.254
- 最大可指派的网络号为126，网络地址为126.0.0.0
- 可指派的A类网络数量为 $2^{(8-1)}$- 2 = 126(*减2是去最小网络号和最大网络号127*)
- 每个A类网络中可分配的地址数量为$2^{24}$ -2 = 16777214(减2是去掉机号为全0的网络地址和全1的广播地址



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222123356623.png" alt="image-20231222123356623" style="zoom:67%;" />

B类（网络2位，主机2位，范围 128.0.0.0~191.255.255.254）

- 最小可指派的网络号为128.0
- 网络地址为128.0.0.0
- 最大可指派的网络号为191.255
- 网络地址为191.255.0.0
- 网络数量$2^{(16-2)}=16384$
- 每个B类网络中可分配的地址数量为$2^{16} -2 = 65534$(减2是**去掉机号为全的网络地址和全1的广播地址**)
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222123635307.png" alt="image-20231222123635307" style="zoom:50%;" />

C类（网络号3位，主机号1位，范围192.0.0.0~223.255.255.254）

- 最小可指派的网络号为192.0.0
- 网络地址为192.0.0.0
- 最大可指派的网络号为223.255.255
- 网络地址为223.255.255.0
- 可指派的C类网络数量为 $2^{(24-3)}= 2097152$
- 每个C类网络中可分配的地址数量为$2^8$ -2 = 254(减2是**去掉机号为全0的网络地址和全1的广播地址**)
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222123902587.png" alt="image-20231222123902587" style="zoom:50%;" />

各个类别的区分

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222124124395.png" alt="image-20231222124124395" style="zoom: 50%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222140209484.png" alt="image-20231222140209484" style="zoom:50%;" />

 练习题<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222140623354.png" alt="image-20231222140623354" style="zoom:67%;" />

分类编址的最大缺陷就是不灵活，容易造成ipv4地址的浪费



##### 划分子网编址

随着更多的中小网络加入因特网，<span alt='black'>IPv4分类编址方法不够灵活、容易造成大量IPv4地址资源浪费</span>的缺点就暴露出来了。



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222140959456.png" alt="image-20231222140959456" style="zoom: 50%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222141053702.png" alt="image-20231222141053702" style="zoom:50%;" />

通过子网掩码进行子网划分

<span alt='orange'>子网掩码</span>可以表明分类IPv4地址的主机号部分被借用了几个比特作为子网号

与IPv4地址类似，子网掩码也是由*32比特*构成的

用左起多个**连续的比特1**对应IPV4地址中的**网络号和子网号**

之后的多个**连续的比特0**对应IPv4地址中的**主机号**



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222141509830.png" alt="image-20231222141509830" style="zoom: 50%;" />

将划分子网的**IPv4地址与相应的子网掩码**进行逐比特的**逻辑与运算**，就可**得到**该IPV4地址所在**子网的网络地址**。

例题：  

![image-20231222142004745](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222142004745.png)

真题：

![image-20231222143128891](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222143128891.png)

默认子网掩码：未划分子网时使用的子网掩码

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222143321731.png" alt="image-20231222143321731" style="zoom:50%;" />

##### 无分类编址方法

IP4地址的划分子网编址方法在一定程度上缓解了因特网在发展中遇到的困难，但是数量巨大的C类网$2^{24-3} = 2097152$)由于其**每个网络所包含的地址数量太小**($2^8$ = 256)，因此**并没有得到充分使用**，而因特网的IPv4地址仍在加速消耗，整个**IPv4地址空间面临全部耗尽的威胁。**

为此，因特网工程任务组IETF又提出了采用**无分类编址**的方法，来解决IPv4地址资源紧张的问题，同时还专门成立IPv6工作组负责研究新版本的IP，以彻底解决IPv4地址耗尽问题

1993年，因特网工程任务组IETF发布了**无分类域间路由选择**(**C**lassless **I**nter-**D**omain Routing，CIDR)的RFC文档[RFC1517~1519，RFC1520]。

**CIDR消除了传统A类、B类和C类地址以及划分子网的概念**

**CIDR可以更加有效地分配IPv4地址资源，并且可以在IPv6使用之前允许因特网的规模继续增长.**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222143803727.png" alt="image-20231222143803727" style="zoom:50%;" />

无分类编址方法使用的**地址掩码**与划分子网使用的**子网掩码**类似，由**32比特构成**

用**左起多个连续的比特1**对应IPv4地址中的**网络前缀**

之后的**多个连续的比特0**对应IP4地址中的**主机号**

例题：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222144251627.png" alt="image-20231222144251627" style="zoom:50%;" />

一般不给出点分十进制，而是给出斜线写法

例如<span alt='purple'>128.14.35.7/20</span>表示前20位为网络前缀，后12位为主机号

实际上无分类域间路由选择CIDR是将网络前缀都相同的、连续的多个无分类IPv4地址，组成**一个CIDR地址块**，只要知道CIDR地址块中的任何一个地址，就可以知道该地址块的以下全部细节:

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222144633411.png" alt="image-20231222144633411" style="zoom:45%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222144820249.png" alt="image-20231222144820249" style="zoom:50%;" />

好处：可以根据需求分配CIDR块，减少浪费

**网络前缀越长，地址块越小，路由越具体**

若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为**最长前缀匹配**，因为这样的路由更具体。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222145459659.png" alt="image-20231222145459659" style="zoom:67%;" />

聚合为一个网络，找公共前缀，减少对路由表的占用 

真题1：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222145939361.png" alt="image-20231222145939361" style="zoom:50%;" />



真题2：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222150250277.png" alt="image-20231222150250277" style="zoom: 50%;" />

真题3：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222150504812.png" alt="image-20231222150504812" style="zoom:50%;" />![image-20231222151009606](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222151009606.png)

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222150504812.png" alt="image-20231222150504812" style="zoom:50%;" /><img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222151009606.png" alt="image-20231222151009606" style="zoom:50%;" />d解析

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222151137036.png" alt="image-20231222151137036" style="zoom:50%;" />这个b划分了之后还有新的地址块加入





#### IPv4的应用规划

划分子网

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222151440247.png" alt="image-20231222151440247" style="zoom:50%;" />

定长划分：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222152700997.png" alt="image-20231222152700997" style="zoom: 50%;" />

变长划分：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222153141344.png" alt="image-20231222153141344" style="zoom:50%;" />

变长划分的原则，先给大的子块进行划分，且<span alt='orange'>每个子块的起点位置不能随便选取，只能选取主机号部分是块大小整数倍的地址作为起点。</span>>



![image-20231222154708285](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222154708285.png)



<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/038557635833059247655395102b13b3.png" alt="img" style="zoom:50%;" />

#### IPv4地址和MAC地址

![image-20231222160107320](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222160107320.png)

IP地址有源IP地址和目的IP地址

MAC地址有源MAC地址和目的MAC地址

在数据包的传送过程中，数据包的<span alt='purple'>源IP地址和目的IP地址保持不变</span>

在数据包的传送过程中，数据包的<span alt='purple'>源MAC地址和目的MAC地址逐链路(或逐网络)改变</span>

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222160530973.png" alt="image-20231222160530973" style="zoom:50%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222160704777.png" alt="image-20231222160704777" style="zoom:50%;" />

真题：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231222160914443.png" alt="image-20231222160914443" style="zoom: 50%;" />

如果仅使用MAC地址进行通信，则会出现以下主要问题:

- 因特网中的每台路由器的**路由表**中就必须**记录**因特网上**所有主机和路由器各接口的MAC地址**
- 手工给各路由器配置路由表几乎是不可能完成的任务，即使使用路由协议让路由器通过相互交换路由信息来自动构建路由表，也会因为**路由信息需要包含海量的MAC地址信息而严重占用通信资源。**
- **包含海量MAC地址的路由信息需要路由器具备极大的存储空间**，并且会给分组的**查表转发带来非常的时延**。

因特网的网际层**使用IP地址进行寻址**，就可使因特网中各**路由器**的路由表中的路由记录的数量大大减少因为**只需记录部分网络的网络地址**，而不是记录每个网络中各通信设备的各接口的MAC地址。

- 路由器收到IP数据报后，根据其首部中的目的IP地址的网络号部分，基于自己的路由表进行查表转发

查表转发的结果可以指明IP数据报的下一跳路由器的IP地址，但无法指明该IP地址所对应的MAC地址。因此，在数据链路层封装该IP数据报成为帧时，顿首部中的目的MAC地址字段就无法填写该问题需要使用网际层中的**地址解析协议ARP**来解决



#### 地址解析协议ARP

通过已知IP地址找到相应的MAC地址

例子：

每个主机都有自己的ARP高速缓存表，里面记录着ip对应的mac地址。

如果A的ARP高速缓存表中没有，某个ip对应的mac地址，就会发送一个ARP请求报文（广播报文），交换机接受到之后，就从所有接口转发出去

如果有接收方B的ip地址是目的地址，那么，先将发过来的ip地址进行存入到自己（B）的ARP高速缓存表，然后再给源ip地址发送相应报文（单播报文），其内容包括mac地址

然后A的ARP高速缓存表，就会存下B的IP地址及mac地址



通过ARP自动获取，生命周期默认为两分钟。

手工配置，不同操作系统下的生命周期不同，例如系统重启后不存在或系统重启后依然有效。

IP地址和MAC的对应关系不是一成不变的。比如主机更换了网卡对应的MAC地址就会变化

ARP相关问题：

- 由于ARP协议的主要用途是从网际层使用的IP地址解析出在数据链路层使用的MAC地址。因此，有的教材将ARP协议划归在**网际层**，而有的教材将ARP协议划归在**数据链路层**。这两种做法都是可以的。
- 除了本节课介绍的ARP请求报文和响应报文，**ARP协议还有其他类型的报文**，例如用于检查IP地址冲突的“无故ARP” (Gratuitous ARP)。
- 由于ARP协议很早就制定出来了(1982年11月)当时并没有考虑网络安全问题。因此，**ARP协议没有安全验证机制**，存在**ARP欺骗和攻击等**问题







#### IP数据报的发送和转发流程

**主机**发送IP数据报

**路由器**转发IP数据报

![image-20231225111007255](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225111007255.png)

为了将重点放在TCP/IP体系结构的网际层发送和转发IP数据报的过程上，在之后的举例中，将忽略以下过程:
(1) 使用ARP协议来获取目的主机或路由器接口的MAC地址的过程。(2) 以太网交换机自学习和转发顿的过程

为了要确认发送给哪个路由器，在同一网络中，需要给各个主机指定默认网关 

当本网络的主机和其他网络中的主机进行通信时，将IP数据报发送给默认网关



路由器收到需要转发的数据报后，会进行检查

- 检查收到的IP数据报是否正确生存时间是否结束;首部是否误码若不正确，则丢弃该IP数据报，并向发送该IP数据报的源主机发送差错报告。
- 基于IP数据报首部中的目的IP地址在路由表中进行查找。
    若找到匹配的路由条目，则按该路由条目的指示进行转发，否则丢弃该IP数据报，并向发送该IP数据报的源主机发送差错报告。

![image-20231225111705020](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225111705020.png)

同一个网络中（同一个交换机连接的）是直接交付

路由器不转发广播IP数据报，即路由器隔离广播域如果因特网中数量巨大的路由器收到广播IP数据报后都进行转发，则会造成巨大的广播风暴，严重浪费
因特网资源

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225112044626.png" alt="image-20231225112044626" style="zoom:67%;" />

因为H1和H2的网络前缀相同，因此属于同一个网络；H3和H4也是如此。

但是H2和H3网络前缀不相同，因此设备3是路由器，来连接不同的网络。

路由器的接口为默认网关。



#### IPv4数据报的首部格式

IPv4数据报的首部格式及其内容是**实现IPv4协议各种功能的基础**

在TCP/IP标准中，各种数据格式常常以**32比特(即4字节)为单位**来描述

固定部分是指**每个IPv4数据报都必须要包含的部分**

某些IPv4数据报的首部，除了包含20字节的固定部分，还包含一些可选的字段来**增加IPv4数据报的功能**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225121027533.png" alt="image-20231225121027533" style="zoom:67%;" />

- 版本：长度为4个比特，用来表示**IP协议的版本**
    - 通信双方使用的IP协议的版本必须一致。目前广泛使用的IP协议的版本号为4 (即IPv4，还有IPv6)
- 首部长度：长度为4个比特，该字段的取值以4字节为单位，用来**表示IPv4数据报的首部长度**。
    - 最小取值为二进制的0101，即十进制的5，再乘以4字节单位，表示IPv4数据报首部只有20字节固定部分最大取值为二进制的1111，即十进制的15，再乘以4字节单位，表示IPv4数据报首部包含20字节固定部分和最大40字节可变部分
- 可选字段：长度从1字节到40字节不等，用来支持排错、测量以及安全措施等功能。
    - 虽然可选字段增加了IPv4数据报的功能，但这同时也使得IPv4数据报的首部长度成为可变的，这就增加了因特网中每一个路由器处理IPv4数据报的开销
        实际上，可选字段很少被使用。
- 填充字段：**用来确保IPv4数据报的首部长度是4字节的整数倍**，使用全0进行填充
    - 当首部长度 (20字节固定部分+可变部分)的长度不是4字节整数倍时，填充相应数量的全0字节以确保IPv4数据报的首部长度是4字节的整数倍。
- 区分服务字段：
    - 长度为8个比特，用来获得更好的服务。
    - 该字段在旧标准中叫作服务类型，但实际上一直没有被使用过
    - 1998年，因特网工程任务组IETF把这个字段改名为区分服务。利用该字段的不同取值可提供不同等级的服务质量。
    - 只有在使用区分服务时该字段才起作用，一般情况下都不使用该字段
- 总长度字段：
    - 长度为16个比特，该字段的取值**以字节为单位**，用来表示**IPv4数据报的长度(首部长度+数据载荷长度)**最大取值为二进制的16个比特1，即十进制的65535(很少传输这么长的IPv4数据报)
    - 总长度和首部长度的联系：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225122622273.png" alt="image-20231225122622273" style="zoom:67%;" />
- 标识、标识、片偏移：
    - 共同用于IPv4数据报分片
    - 分片：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225122807009.png" alt="image-20231225122807009" style="zoom:67%;" />
    -  标识：长度为16个比特，属于同一个IPv4数据报的**各分片数据报应该具有相同的标识**。
        IP软件会维持一个计数器，每产生一个IPv4数据报，计数器值就加1，并将此值赋给标识字段
    - 标志：
        - 最低位 (More Fragment，MF)  MF=1表示本分片后面还有分片；MF=0表示本分片后面没有分片
        - 中间位 (Don't Fragment，DF)DF=1表示不允许分片；DF=0表示允许分片
            最高位为保留位，必须设置为0
    - 片偏移：长度为13个比特，该字段的取值以8字节为单位，**必须是整数**，用来指出分片IPv4数据报的数据载荷偏移其在原IPv4数据报的位置有多远。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225123636198.png" alt="image-20231225123636198" style="zoom: 50%;" />
    - 易错例题：![image-20231225123857473](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225123857473.png)
    - 正确解析：![image-20231225124049767](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124049767.png)
- 生存时间（Time To Live，TTL）：
    - 长度为8个比特，最大取值为二进制的11111111，即十进制的255。该字段的取值最初以秒为单位。因此，IPv4数据报的最大生存时间最初为255秒。路由器转发IPV4数据报时，将其首部中该字段的值减去该数据报在路由器上所耗费的时间，若结果不为0就转发，否则就丢弃。
    - 生存时间字段后来改为以“**跳数**”为单位，**路由器收到待转发的IPv4数据报时，将其首部中的该字段的值减1若结果不为0就转发，否则就丢弃**
    - 作用：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124507597.png" alt="image-20231225124507597" style="zoom:50%;" />
- 协议字段：
    - 长度为8个比特，用来指明IPv4数据报的**数据载荷是何种协议数据单元PDU**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124622117.png" alt="image-20231225124622117" style="zoom:50%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124635294.png" alt="image-20231225124635294" style="zoom:50%;" />
- 首部检验和：
    - 长度为16个比特，用于检测Pv4数据报在传输过程中其**首部是否出现了差错.**
    - IPv4数据报每经过一个路由器，其首部中的某些字段的值(例如生存时间TTL、标志以及片偏移等)都可能发生变化，因此**路由器都要重新计算一下首部检验和**。
    - 计算方法：
        - ![image-20231225124910547](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124910547.png)
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225124957280.png" alt="image-20231225124957280" style="zoom:50%;" />
        - 由于网际层并不向其高层提供可靠传输的服务，并且计算首部检验和是一项耗时的操作， 因此在IPv6中，路由器不再计算首部检验和，从而更快转发IP数据报



### 静态路由配置

静态路由配置是指用户或网络运维人员使用路由器的相关命令给路由器**人工配置路由表**

人工配置方式**简单、开销小**、但**不能及时适应网络状态 (流量、拓扑等)的变化**，一般只在小规模网络中采用。

配置：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225125850138.png" alt="image-20231225125850138" style="zoom: 50%;" />

默认路由<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225130048711.png" alt="image-20231225130048711" style="zoom:50%;" />

特定主机路由：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225130216212.png" alt="image-20231225130216212" style="zoom:50%;" />

静态路由配置需要注意的问题：

- 路由条目配置错误，甚至导致出现路由环路
- 聚合路由条目时可能引入不存在的网络



### 路由选择协议

#### 路由选择协议概述



路由选择分类：

- 静态路由：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225130501426.png" alt="image-20231225130501426" style="zoom: 40%;" />
- 动态路由：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225130526323.png" alt="image-20231225130526323" style="zoom:40%;" />



因特网采用分层次的路由选择协议：

因特网是全球最大的互联网，有以下三个特点

- 自适应：因特网采用**动态路由选择**，能较好地适应网络状态的变化。
- 分布式：因特网中的**各路由器**通过相互间的信息交互，**共同完成路由信息的获取和更新**
- 分层次：将整个因特网划分为许多较小的**自治系统** (Autonomous System，AS)在自治系统内部和外部采用不同类别的路由选择协议，分别进行路由选择

![image-20231225135148046](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225135148046.png)





#### 路由信息协议RIP

基本概念：

- 路由信息协议(Routing nformation Protocol，**RIP**)是内部网关协议中最先得到广泛使用的协议之一，其相关标准文档为[RFC 1058]。
- RIP要求自治系统AS内的每一个路由器，都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为**距离向量** (Distance-Vector，D-V)。
- RIP使用**跳数** (Hop Count)作为度量 (Metric)来衡量到达目的网络的**距离。**
    - RIP将路由器到直连网络的距离定义为1
    - RIP将路由器到非直连网络的距离定义为所经过的路由器数加1
    - RIP允许一条路径最多只能包含15个路由器，**距离等于16时相当于不可达**。因此**RIP只适用于小型互联网。**

![image-20231225135557046](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225135557046.png)

有些厂商的路由器并没有严格按照RIP标准文档的规定来实现RIP。例如思科路由器中的RIP，将路由器到直连网络的距离定义为0，但这并不影响RIP的正常运行。

- RIP认为**好的路由就是“距离短”的路由**，也就是所**通过路由器数量最少的路由**<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225135709384.png" alt="image-20231225135709384" style="zoom:50%;" />
- 当到达同一目的网络有多条RIP距离相等的路由时，可以进行等价**负载均衡**，也就是将通信量均衡地分布到多条等价的路径上。<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225135834697.png" alt="image-20231225135834697" style="zoom:50%;" />



RIP3个重要特点：

- 和谁交换：仅和**相邻路由器**交换信息
- 交换什么：路由器自己的**路由表**
    即本路由器到所在自治系统AS中各网络的最短RIP距离，以及到各网络应经过的下一跳路由器。
- 何时交换：**周期性交换**（例如，每隔约30s的时间）
    为了加快RIP的收敛速度，当网络拓扑发生变化时，路由器要及时向相邻路由器通告拓扑变化后的路由信息，这称为**触发更新**

工作过程：

- 开始：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225140206218.png" alt="image-20231225140206218" style="zoom:50%;" />
- 结束：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225140247705.png" alt="image-20231225140247705" style="zoom:50%;" />
    - 路由器刚开始工作时，**只知道自己到直连网络的RIP距离为1。**
    - 每个路由器**仅和相邻路由器周期性地交换并更新路由信息**
    - 若干次交换和更新后，**每个路由器都知道到达本自治系统AS内各网络的最短距离和下一跳路由器**，称为**收敛**。

RIP的距离向量算法：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225150720913.png" alt="image-20231225150720913" style="zoom:50%;" />

- 到达目的网络，**相同的下一跳，最新消息**，要更新。比如N2的路由条目要修改

- 发现了新的网络要添加。比如N3的路由条目要添加到路由器D的路由表中。
- 到达目的网络，**不同的下一跳，新路由优势**，要更新。比如到达N6经过不同的下一跳，且通过新路由距离更小。
    - 如果是**劣势**，比如由C达到的N9，距离更大，因此**不添加**
- 到达目的网络，**RIP距离相同，可以等价负载均衡**，添加。比如到达N8也可以通过C，RIP距离相同，添加新的条目。
- 除了上述RIP路由条目更新规则，在RIP的距离向量算法中还包含以下一些**时间参数**
    - 路由器每隔**大约30秒**向其所有相邻路由器发送路由更新报文
    - 若**180秒**(默认)没有收到某条路由条目的更新报文则把该路由条目标记为无效(即把RIP距离设置为16，表示不可达)，若再过一段时间 (如120秒)，还没有收到该路由条目的更新报文，则将该路由条目从路由表中删除。



真题1：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225151330173.png" alt="image-20231225151330173" style="zoom:50%;" />



真题2：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225151648988.png" alt="image-20231225151648988" style="zoom:50%;" />



RIP存在的问题：

- 坏消息传播很慢<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225152101769.png" alt="image-20231225152101769" style="zoom:50%;" />
    - “坏消息传播得慢”的问题又被称为路由环路或**RIP距离无穷计数问题**。这是距离向量算法的一个固有问题。可以采取以下多种措施**减少**出现该问题的概率或减小该问题带来的危害:
    - 限制**最大RIP距离为15** (16表示不可达)
    - 当路由表发生变化时就立即发送路由更新报文(即“**触发更新**”)，而不仅是周期性发送
    - 让路由器记录收到某个特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送(即“水平分割”)。
    - 注意：使用上述措施仍**无法彻底解决问题**（只能减少）。因为在距离向量算法中，每个路由器都缺少到目的网络整个路径的完整信息，无法判断所选的路由是否出现了环路

RIP版本和相关报文的封装：

- 现在较新的RIP版本是1998年11月公布的RIP2[TRFC 2453]，已经成为因特网标准协议。与RIP1相比，RIP2可以**支持变长子网掩码和CIDR**。另外，RIP2还提供**简单的鉴别**过程并支持**多播**。
- RIP相关报文使用运输层的用户数据报协议UDP进行封装，使用的UDP端口号为520。
    - 从**RIP报文封装**的角度看，RIP属于TCP/IP体系结构的**应用层**。
    - 但RIP的核心功能是**路由选择**，这属于TCP/IP体系结构的**网际层**



优缺点：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225152632404.png" alt="image-20231225152632404" style="zoom:50%;" />

因此较小的系统可以使用RIP，较大的就不太适合





#### 开放最短路径优先 OSPF

基本概念：

- 开放最短路径优先 (Open Shortest Path First，OSPF)协议是为了**克服路由信息协议RIP的缺点**在1989年开发出来的。
    - “**开放**”表明OSPF协议不是受某一厂商控制，而是**公开发表**的
    - “**最短路径优先**”是因为使用了Diikstra提出的**最短路径算法** (Shortest Path First，SPF)
- OSPF是基于**链路状态**的，而不像RIP是基于距离向量的。
- OSPF基于链路状态并采用最短路径算法计算路由，从算法上保证了**不会产生路由环路**
- OSPF**不限制网络规模，更新效率高，收敛速度快**

注意：“开放最短路径优先”只是一个路由选择协议的名称，但这**并不表示其他的路由选择协议不是“最短路径优先”**。实际上，用于自治系统AS内部的各种路由选择协议 (例如RIP)，都要寻找一条“最短”的路径。

- 链路状态：
    - 链路状态(Link State，LS)是指本路由器都和**哪些路由器相邻**，以及**相应链路的“代价 (cost)”**
    - “**代价**”用来表示费用、距离、时延和带宽等，这些都由网络管理人员来决定
    - 例子：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225153417827.png" alt="image-20231225153417827" style="zoom:67%;" />
- OSPF路由器邻居关系的建立和维护
    - OSPF相邻路由器之间通过交互**问候 (Hello) 分组**来建立和维护邻居关系
    - 问候(Hello)分组封装在**IP数据报**中，发往**组播地址224.0.0.5**。IP数据报首部中的**协议号字段**的取值为**89**，表明IP数据报的数据载荷为OSPF分组。<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225154755821.png" alt="image-20231225154755821" style="zoom:50%;" />
    - 问候 (Hello) 分组的**发送周期为10秒**
    - 若**40秒**未收到来自邻居路由器的问候 (Hello) 分组则认为邻居路由器不可达
    - 每个路由器都会建立一张**邻居表**
    - OSPF分组直接使用网际层的IP数据报进行封装，而不像RIP报文需要使用运输层用户数据报协议UDP封装。从数据包按网络体系结构逐层封装的角度看，OSPF属于网际层协议，而RIP属于应用层协议 (但其核心功能是路由选择属于网际层)。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225154849441.png" alt="image-20231225154849441" style="zoom:67%;" />
- 链路状态通告
    - 使用OSPF的每个路由器都会产生**链路状态通告**(Link State Advertisement，**LSA**)
    - LSA中包含以下两类链路状态信息
        - **直连网络**的链路状态信息
        - **邻居路由器**的链路状态信息
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225155114069.png" alt="image-20231225155114069" style="zoom:50%;" />
- 链路状态更新分组
    - 链路状态通告LSA被封装在**链路状态更新** (Link State Update，LSU) 分组中，采用**可靠的洪泛法**(Flooding)进行发送。
    - 洪泛法的要点是路由器**向自己所有的邻居路由器发送链路状态更新分组**，收到该分组的各路由器又将该分组转发给自己所有的邻居路由器 (但其上游路由器除外)，以此类推。
    - 可靠是指收到链路状态更新分组后要发送确认，**收到重复的更新分组无需再次转发**，但要发送一次确认。
    - ![image-20231225160231275](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225160231275.png)

- 链路状态数据库
    - 使用OSPF的每一个路由器都有一个**链路状态数据库** (Link State Database，LSDB)，用于**存储链路状态通告LSA**。
    - **通过各路由器洪泛发送封装有各自链路状态通告LSA的链路状态更新分组LSU，各路由器的链路状态数据库LSDB最终将达到一致。**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225160522898.png" alt="image-20231225160522898" style="zoom:50%;" />

- 基于链路状态数据库进行最短路径优先计算
    - 使用OSPF的各路由器，**基于链路状态数据库LSDB进行最短路径优先计算**，构建出各自到达其他各路由器的最短路径，即**构建各自的路由表**。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225164856144.png" alt="image-20231225164856144" style="zoom:67%;" />

OSPF的五种分组类型

- 问候：用来发现和维护邻居路由器的可达性
- 数据库描述：用来向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
- 链路状态请求：用来向邻居路由器请求发送某些链路状态项目的详细信息
- 链路状态更新：路由器使用链路状态更新分组将其链路状态信息进行洪泛发送，即用洪泛法对整个系统更新链路状态。
- 链路状态确定：对链路状态更新分组的确认分组。

基本工作过程：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225165505928.png" alt="image-20231225165505928" style="zoom:50%;" />

- 多点接入网络中的OSPF路由器
    - 为了减少所发送问候分组和链路状态更新分组的数量，OSPF采用以下措施:
        - 选举**指定路由器** (Designated Router，DR）和**备用的指定路由器** (Backup DesignatedRouter，BDR）
        - **所有的非DR/BDR只与DR/BDR建立邻居关系**
        - **非DR/BDR之间通过DR/BDR交换信息**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225170718286.png" alt="image-20231225170718286" style="zoom:67%;" />

OSPF划分区域：

- 为了使OSPF协议能够用于规模很大的网络，OSPF把一个自治系统AS再划分为若干个更小的范围，称为区域(area)
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225173040651.png" alt="image-20231225173040651" style="zoom:50%;" />
- 本例子中R6为自治系统边界路由器（AS Border Router，ASBR）；R3，R4，R5，R6，R7都是主干路由器
- 区域路由器（Internal Router,IR）：区域1内的R1和R2，区域2内的R8，区域3内的R9
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225173703899.png" alt="image-20231225173703899" style="zoom:50%;" />



例题：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225173926074.png" alt="image-20231225173926074" style="zoom:50%;" />

#### 边界网关协议BGP

边界网关协议(Border Gateway Protocol，**BGP**)属于外部网关协议EGP这个类别，用于**自治系统AS之间的路由选择协议**

由于在不同AS内度量路由的“代价”(距离、带宽、费用等) 可能不同，因此**对于AS之间的路由选择使用统一的“代价”作为度量来寻找最佳路由是不行的。**

![image-20231225182316880](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225182316880.png)

没有统一的度量，因此去寻找最佳路由是不现实的

自治系统之间的路由选择协议应当允许使用多种路由选择策略。这些策略包括政治、经济、安全等，它们都是由网络管理人员对每一个路由器进行设置的。但这些策略并不是自治系统之间的路由选择协议本身。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225182441708.png" alt="image-20231225182441708" style="zoom:50%;" />

- BGP只能是力求寻找一条能够到达目的网络且比较好的路由 (即不能兜圈子) ，而并非要寻找一条最佳路由。

- 在配置BGP时，每个AS的管理员要选择至少一个路由器作为该AS的“**BGP发言人**”

- 一般来说，两个BGP发言人都是通过一个共享网络连接在一起的，而BGP发言人往往就是**BGP边界路由器**

- 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站** (neighbor)或**对等站** (peer)

- BGP发言人除了运行BGP协议外，还必须运行自己所在AS所使用的内部网关协议IGP，例如RIP或OSPF
- BGP发言人交换网络可达性的信息，也就是**要到达某个网络所要经过的一系列自治系统.**
- 当BGP发言人相互交换了网络可达性的信息后，各BGP发言人就**根据**所采用的**策略**，从收到的路由信息中**找出到达各自治系统的较好的路由**，也就是构造出树形结构且**不存在环路的自治系统连通图。**

- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231225183235857.png" alt="image-20231225183235857" style="zoom:50%;" />

![image-20231230173915809](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230173915809.png)

#### 路由器的基本工作原理

路由器：**路由器**是一种具有多个输入端口和输出端口的**专用计算机**，其任务是**转发分组**

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230174214485.png" alt="image-20231230174214485" style="zoom:67%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230174345561.png" alt="image-20231230174345561" style="zoom:67%;" />





###  网际控制报文协议ICMP

概述：

- 为了更**有效地转发IP数据报**以及提高IP数据报交付成功的机会TCP/IP体系结构的**网际层**使用了**网际控制报文协议** (Internet Control Message Protocol，**ICMP**) IRFC 792]。
- **主机**或**路由器**使用ICMP来发送**差错报告报文**和**询问报文**
- **ICMP报文被封装在IP数据报中发送**

ICMP报文类型

差错报文

- 终点不可达：**当路由器或主机不能交付IP数据报时，就向源点发送终点不可达报文**。具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230175108399.png" alt="image-20231230175108399" style="zoom:50%;" />
- 源点抑制：**当路由器或主机由于拥塞而丢弃IP数据报时，就向发送该IP数据报的源点发送源点抑制报文**，使源点知道应当把IP数据报的发送速率放慢。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230175129744.png" alt="image-20231230175129744" style="zoom:50%;" />
- 时间超过：当路由器收到一个目的IP地址不是自己的IP数据报时，会将其首部中**生存时间TTL字段的值减1**。若结果不则路由器将该数据报转发出去:**若结果为0，路由器不但要丢弃该数据报，还要向发送该IP数据报为0的源点发送时间超过 (超时) 报文**
    另外**当终点在预先规定的时间内未能收到一个数据报的全部数据报分片时，就把已收到的数据报片都丢弃也会向源点发送时间超过 (超时) 报文**
    - ![image-20231230175529518](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230175529518.png)
- 参数问题：当路由器或目的主机收到IP数据报后，根据其首部中的检验和字段的值发现**首部**在传送过程中出现了**误码**，就**丢弃该数据报**，并**向发送该数据报的源点发送参数问题报文**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230180754731.png" alt="image-20231230180754731" style="zoom:50%;" />
- 改变路由：路由器把改变路由报文发送给主机，**让主机知道下次应将IP数据报发送给另外的路由器**，这样可以**通过更好的路由到达目的主机**。
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230181019031.png" alt="image-20231230181019031" style="zoom:50%;" />
- 不发差错报文的情况
    - 对ICMP差错报告报文不再发送ICMP差错报告报文。
    - 对第一个分片的IP数据报片的所有后续数据报片都不发送ICMP差错报告报文
    - 对具有多播地址的IP数据报都不发送ICMP差错报告报文
    - 对具有特殊地址(例如127.0.0.0或0.0.0.0)的IP数据报不发送ICMP差错报告报文

询问报文：

- 回送请求和回答：由主机或路由器向一个特定的目的主机或路由器发出
    收到此报文的主机或路由器必须给发送该报文的源主机或路由器发送ICMP回送回答报文
    这种询问报文**用来测试目的站是否可达以及了解其有关状态**
- 时间戳请求和回答：用来请求某个主机或路由器回答当前的日期和时间
    在ICMP时间戳回答报文中有一个32比特的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒
    这种询问报文**用来进行时钟同步和测量时间**



ICMP典型应用

- 分组网间探测PING用来**测试主机或路由器之间的连通性**
    - PING是TCP/IP体系结构的**应用层直接使用网际层ICMP**的一个例子，它并不使用运输层的TCP或UDP
    - PING应用所**使用的ICMP报文类型为回送请求和回答**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230182307289.png" alt="image-20231230182307289" style="zoom:50%;" />
- 跟踪路由
    - 跟踪路由应用traceroute，用于**探测IP数据报从源主机到达目的主机要经过哪些路由器**
    - 在不同操作系统中，traceroute应用的命令和实现机制有所不同
        - 在**UNIX版本**中，具体命令为“**traceroute**”其在运输层使用**UDP协议**，在网络层使用**ICMP报文类型只有差错报告报文。**
        - 在**Windows版本**中，具体命今为“**tracert**”，其**应用层直接使用网际层的ICMP协议**，所使用的**ICMP报文类型有回送请求和回答报文以及差错报告报文。**
        - ![image-20231230182739134](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230182739134.png)



### 虚拟专用网VPN和网络地址转化

虚拟专用网 (Virtual Private Network，**VPN**): **利用公用的因特网**作为本机构各专用网之间的通信载体这样形成的网络又称为虚拟专用网。

给专用网内各主机配置的IP地址应该是该**专用网所在机构可以自行分配的IP地址**，这类IP地址仅在机构内部有效，称为**专用地址** (Private Address)，不需要向因特网的管理机构申请。

IRFC 19181规定了以下三个CIDR地址块中的地址作为专用地址:

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230183205415.png" alt="image-20231230183205415" style="zoom:67%;" />

因特网中的所有路由器，对目的地址是专用地址的IP数据报一律不进行转发这需要由因特网服务提供者ISP对其拥有的因特网路由器进行设置来实现

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230183343008.png" alt="image-20231230183343008" style="zoom:67%;" />

IP数据报在因特网中可能要经过多个网络和路由器，但从逻辑上看，路由器R1和R2之间好像是一条直通的点对点链路，因此也被称为IP隧道技术

本例所示的是同一机构内不同部门的内部网络所构成的VPN，又称为**内联网VPN。**

有时，一个机构的虚拟专用网VPN需要某些外部机构(通常是合作伙伴)参加进来，这样的VPN就称为**外联网VPN。**

在外地工作的员工需要访问公司内部的专用网时，只要在任何地点接入因特网，运行驻留在员工PC中的VPN软件，在员工的PC和公司的主机之间建立VPN隧道，就可以访问专用网中的资源，这种虚拟专用网又称为**远程接入VPN**。





网络地址转换

- 原因：尽管因特网采用了无分类编址方法来减缓IPv4地址空间耗尽的速度，但**由于因特网用户数量的急剧增长**，特别是**大量小型办公室**和**家庭网络**接入因特网的需求不断增加，**IPv4地址空间即将耗尽的危险仍然没有解除**(实际上，因特网号码分配管理局IANN于2011年2月3日宣布，IPv4地址已经分配完毕)
- **网络地址转换**(Network Address Translation，**NAT**)技术于1994年被提出，用来缓解IP4地址空间即将耗尽的问题。
    - NAT能**使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源.**
    - 这种方法需要在专用网络连接到因特网的路由器上**安装NAT软件**。装有NAT软件的路由器称为**NAT路由器**，它**至少要有一个有效的外部全球地址IP(G)**。这样，所有使用内部专用地址的主机在和外部因特网通信时，都要**在NAT路由器上将其内部专用地址转换成IP（G）**。
- 最基本的NAT方法
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230190606868.png" alt="image-20231230190606868" style="zoom:50%;" />
- 网络地址和端口号转化方法
    - 由于目前绝大多数基于TCP/IP协议栈的网络应用，都使用运输层的传输控制协议TCP或用户数据报协议UDP，为了**更加有效地利用NAT路由器中的全球IP地址，现在常将NAT转换和运输层端口号结合使用。**
        - 这样就可以使内部专用网中使用专用地址的**大量主机**，**共用NAT路由器上的1个全球IP地址**，因而可以同时与因特网中的不同主机进行通信。
    - 将NAT和运输层端口号结合使用，称为**网络地址与端口号转换** (Network Address and Port Translation,NAPT)
        - 现在很多家用路由器将家中各种智能设备 (手机、平板、笔记本电脑、台式电脑、物联网设备等接入因特网，这种路由器实际上就是一个**NAPT路由器**，但往往并不运行路由选择协议。
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20231230192156506.png" alt="image-20231230192156506" style="zoom:50%;" />
    - 尽管NAT(和NAPT)的出现在很大程度上缓解了IPv4地址资源紧张的局面，但**NAT (和NAPT)对网络应用并不完全透明，会对某些网络应用产生影响**。
    - NAT(和NAPT)的一个重要特点就是**通信必须由专用网内部发起，因此拥有内部专用地址的主机不能直接充当因特网中的服务器**
    - 对于目前P2P这类需要外网主机主动与内网主机进行通信的网络应用，在通过NAT时会遇到问题，需要网络应用自身使用一些特殊的**NAT穿透技术**来解决



### IP多播技术

#### 基本概述

**多播** (Multicast，也称为组播)是一种实现“**一对多**”通信的技术，与传统单播“一对一”通信相比，多播可以**极大地节省网络资源。**

在**因特网上进行的多播**，称为**IP多播**

![image-20240101140821978](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101140821978.png)



当多播组的成员数量很大时，采用多播方式可以显著地减少网络中各种资源的消耗

路由器需要解决的主要问题：IP多播的寻址问题，多播路由选择协议



在**IPv4**中，**D类地址**被作为**多播地址**

**多播地址只能用作目的地址**，而不能用作源地址.

用每一个D类地址来标识一个多播组，**使用同一个IP多播地址接收IP多播数据报的所有主机就构成了一个多播组。**

- **每个多播组的成员是可以随时变动**的，一台主机可以随时加入或离开多播组。
- **多播组成员的数量和所在的地理位置也不受限制，一台主机可以属于几个多播组.**

非多播组成员也可以向多播组发送IP多播数据报

与IP数据报相同，IP多播数据报也是“**尽最大努力交付**”，不保证一定能够交付给多播组内的所有成员

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101141130873.png" alt="image-20240101141130873" style="zoom:50%;" />



IPv4多播地址又可分为**预留的多播地址** (永久多播地址)、**全球范围可用的多播地址**以及本地管理的多播地址[RFC 3330]

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101141509548.png" alt="image-20240101141509548" style="zoom:50%;" />



IP多播可以分为两种

- 只在**本局域网**上进行的**硬件多播**
- 在**因特网**上进行的**多播**

目前大部分主机都是通过局域网接入因特网的。因此，在因特网上进行多播的最后阶段，还是要把IP多播数据报**在局域网上用硬件多播交付**给多播组的所有成员



#### 在局域网上进行硬件多播

由于MAC地址(也称为硬件地址)有多播MAC地址这种类型，因此只要把**IPV4多播地址映射成多播MAC地址**，即可将IP多播数据报封装在局域网的MAC帧中，而MAC顿首部中的目的MAC地址字段的值，就设置为由IPv4多播地址映射成的多播MAC地址。这样，可以很方便地**利用硬件多播来实现局域网内的IP多播**。

当给某个多播组的成员主机配置其所属多播组的IP多播地址时，系统就会根据映射规则从该IP多播地址生成相应的局域网多播MAC地址。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101141944843.png" alt="image-20240101141944843" style="zoom:50%;" />

因特网号码指派管理局IANA，将自己从IEEE注册管理机构申请到的以太网MAC地址块中从**01-00-5E-00-00-00到01-00-5E-7F-FF-FF**的多播MAC地址，用于映射IPv4多播地址

- 这些多播MAC地址的**左起前25个比特都是相同**的，**剩余23个比特可以任意变化**，因此共有$2^{23}$个
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101142229018.png" alt="image-20240101142229018" style="zoom:50%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101142302596.png" alt="image-20240101142302596" style="zoom:50%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101142425933.png" alt="image-20240101142425933" style="zoom:50%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101142457746.png" alt="image-20240101142457746" style="zoom:50%;" />
- 由于IP多播地址与多播MAC地址的映射关系不是唯一的，因此**收到IP多播数据报的主机还要在网际层利用软件进行过滤**，把不是主机要接收的IP多播数据报丢弃
- 先接收再过滤<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101142718557.png" alt="image-20240101142718557" style="zoom:50%;" />





#### 在因特网上进行IP多播需要的两种协议

要在因特网上进行IP多播，就必须要考虑**IP多播数据报经过多个多播路由器进行转发**的问题。

**多播路由器**必须**根据**IP多播数据报首部中的**IP多播地址**，将其**转发**到有该多播组成员的局域网



- 网际组管理协议
    - 网际组管理协议 (internet Group Management Protocol，**IGMP**)是TCP/IP体系结构网际层中的协议，其作用是**让连接在本地局域网上的多播路由器知道本局域网上是否有主机**(实际上是主机中的某个进程)**加入或退出了某个多播组。** 
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101143431504.png" alt="image-20240101143431504" style="zoom:50%;" />
    - **IGMP仅在本网络有效**，使用IGMP**并不能知道**多播组所包含的**成员数量**，**也不能知道**多播组的**成员都分布**在哪些网络中。
    - 仅使用IGMP并不能在因特网上进行IP多播。连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把IP多播数据报用最小的代价传送给所有的多播组成员，这就需要使用**多播路由选择协议**
- 多播路由选择协议
    - **多播路由选择协议**的主要任务是: 在多播路由器之间为每个多播组建立一个**多播转发树**
    - 多播转发树**连接多播源和所有拥有该多播组成员的路由器.**
    - **IP多播数据报只要沿着多播转发树进行洪泛**，就能被传送到所有拥有该多播组成员的多播路由器
    - 之后，**在多播路由器所直连的局域网内**，多播路由器通过**硬件多播**，将IP多播数据报发送给该多播组的所有成员。
    - 针对**不同的多播组需要维护不同的多播转发树**，而且必须**动态地适应多播组成员的变化**，但此时网络拓扑并不一定发生变化，因此**多播路由选择协议要比单播路由选择协议 (例如RIP、OSPF等)复杂得多。**
    - 即使某个**主机不是任何多播组的成员**，它**也可以向任何多播组发送多播数据报**
    - 为了覆盖多播组的所有成员，多播转发树可能要经过一些没有多播组成员的路由器(例如下图中的R2)
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101144504756.png" alt="image-20240101144504756" style="zoom:67%;" />
    - 



#### 网际组管理协议IGMP

三种报文类型：成员报告报文、成员查询报文、离开组报文

IGMP报文被封装在IP数据报中传送

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101144847307.png" alt="image-20240101144847307" style="zoom:67%;" />



基本工作原理

- 加入多播组
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101145138649.png" alt="image-20240101145138649" style="zoom: 50%;" />
    - IGMP成员报告报文中包含**要加入的IP多播组的地址。**
    - IP多播数据报的目的地址也为**要加入的IP多播组的地址**
    - 该IP多播数据报会被本网络中该多播组的所有成员主机以及多播路由器接收。
    - 多播路由器收到一个未知多播组的IGMP成员报告，就会将该多播组的地址**添加**到自己的多播组列表中。
- 监视多播组成员变化 
    - IGMP成员查询报文的内容可以是：0.0.0.0，表示全部多播组
    - IP多播数据报的目的地址：224.0.0.1是特殊的IP多播地址，在本网络中所有参加多播的主机和路由器的网际层都会接收该多播数据报 
    - 收到该多播数据报的特定多播组或任意多播组的成员将会发送一个封装有IGMP成员报告报文的IP多播数据报作为**应答**。为了减少不必要的重复应答，每个多播组只需要有一个成员应答就可以了，**因此采用延迟(1~10秒) 响应策略**
    - ![image-20240101145416126](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101145416126.png)
    - 同一网络中的多播路由器可能不止一个，但没有必要每个多播路由器都周期性地发送IGMP成员查询报文
    - 只要在这些多播路由器中选择一个作为**查询路由器**，由查询路由器发送IGMP成员查询报文，而其他的多播路由器仅被动接收响应并更新自己的多播组列表即可。
    - 选择查询路由器的方法:
        - 每个多播路由器若监听到源IP地址比自己的IP地址小的IGMP成员查询报文则退出选举
        - 最后，网络中只有**IP地址最小的多播路由器成为查询路由器**
    - 多播路由器如果长时间未收到某个多播组的成员报告，则将该多播组从自己的多播组列表中**删除**
- 退出多播组
    - IGMPv2在IGMPv1的基础上增加了一个可选项:当主机要退出某个多播组时，可主动发送一个**离开组报文**，而不必等待多播路由器的查询。这样**可使多播路由器能够更快地发现某个组有成员离开**
    - IGMP离开组报文的内容包含主机**要退出的多播组的地址。**
    - IP多播数据报的目的地址为**224.0.0.2**，在本网络中的所有多播路由器的网际层都会接受该多播数据报。
    - 多播路由器在收到离开组报文时**不能立即将多播组从自己的多播组列表中删除**，因为在本网络中可能还有该多播组的其他成员因此，多播路由器在收到离开组报文后，**会立即针对该多播组发送一个IGMP成员查询报文**。若在预定时间内仍然没有收到该多播邹的IGMP成员报告报文，才将该多播组从自己的多播组列表中**删除**







#### 多播路由选择协议

多播路由选择协议的主要任务是: **在多播路由器之间为每个多播组建立一个多播转发树.**

- 多播转发树连接多播源和所拥有该多播组成员的路由器

目前有以下两种方法来构建多播转发树:

- **基于源树** (Source-Base Tree) 多播路由选择
    - 基于源树的多播路由选择的最典型算法是**反向路径多播**(Reverse Path Multicasting，**RPM**) 算法
    - RPM算法包含以下两个步骤:
        - 1.利用**反向路径广播** (Reverse Path Broadcasting，**RPB**)算法建立一个**广播转发树**.
        - 2.利用剪枝(Pruning)算法，剪除广播转发树中的下游非成员路由器，获得一个**多播转发树**
    - 要建立广播转发树，可以使用洪泛 (Flooding)法。
        - 洪泛法<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101155856422.png" alt="image-20240101155856422" style="zoom:50%;" />
        - 利用**反向路径广播RPB算法**生成的**广播转发树**，**不会存在环路**，因此可以避免广播分组在环路中兜圈。
        - RPB算法的要点是:每一台路由器在收到一个广播分组时，先**检查该广播分组是否是从源点经最短路径专送来的**。
            - 若是，本路由器就从自己除刚才接收该广播分组的接口的所有其他接口转发该广播分组。
            - 否则，丢弃该广播分组
            - 如果本路由器有好几个邻居路由器都处在到源点的最短路径上，也就是**存在好几条同样长度的最短路径**，那么只能选取一条最短路径。**选取**的规则是这几条最短路径中的**邻居路由器的IP地址最小的那条最短路径**
        - RPB中“反向路径”的意思是: **在计算最短路径时把源点当作终点**
            - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101184858448.png" alt="image-20240101184858448" style="zoom: 67%;" />
            - 如果R8不是多播组成员，并且没有下游路由器的叶节点从广播转发树上剪除就可以实现多播转发树，R8向其上层发送剪枝报文
- **组共享树** (Group-Shared Tree) 多播路由选择
    - 组共享树多播路由选择采用**基于核心的分布式生成树算法**来建立共享树
        - 该方法在**每个多播组**中指定一个**核心 (core) 路由器**，以该路由器为**根**，建立一棵**连接多播组的所有成员路由器的生成树**，作为多播转发树。
    - 每个多播组中除了核心路由器，其他所有成员路由器都会向自己多播组中的核心路由器单播**加入报文**
        - 加入报文通过单播朝着核心路由器转发，直到它**到达**已经属于**该多播生成树的某个节点**或者**直接到达该核心路由器。**
        - 加入报文所经过的路径，就确定了一条**从单播该报文的边缘节点到核心路由器之间的分支**，而这个新分支就被**嫁接**到现有的**多播转发树**上。
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101190134126.png" alt="image-20240101190134126" style="zoom:80%;" />

因特网的路由选择协议：

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101190359604.png" alt="image-20240101190359604" style="zoom:50%;" />



### 移动IP概述

移动性对因特网的影响

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101190601985.png" alt="image-20240101190601985" style="zoom: 50%;" />



为了解决应用场景3，提出的移动IP。

相关概念：

- **移动IP** (Mobile P)是因特网工程任务组IETF开发的一种技术RFC 3344]，该技术使得**移动主机在各网络之间漫游时，仍然能够保持其原来的IP地址不变。**
- 移动IP技术还为因特网中的非移动主机提供了相应机制，使得它们能够将IP数据报正确发送到移动主机.
- 
    - 归属网络：每个移动主机都有一个**默认连接的网络或初始申请接入的网络**，称为归属网络
    - 归属地址：移动主机在**归属网络中的IP地址在其整个移动通信过程中是始终不变的**，因此称为永久地址 (Permanent Address) 或归属地址(Home Address) 。
    - 归属代理：在**归属网络中，代表移动主机执行移动管理功能的实体**称为归属代理 (HomeAgent)。归属代理通常就是连接在归属网络上的路由器，然而它作为代理的特定功能则是在网络层完成的。
- 
    - 外地网络：移动主机**当前漫游所在的网络**称为外地网络 (Foreign Network) 或被访网络 (VisitedNetwork)
    - 外地代理：**在外地网络中，帮助移动主机执行移动管理功能的实体**称为外地代理 (ForeignAgent)
    - 外地代理通常就是连接在外地网络上的路由器。**外地代理会为移动主机提供一个临时使用的属于外地网络的转交地址 (Care-of Address)。**

基本工作原理：

- 代理发现与注册
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101191544529.png" alt="image-20240101191544529" style="zoom:50%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101191307939.png" alt="image-20240101191307939" style="zoom:50%;" />
- 固定主机向移动主机发送IP数据报
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101191917287.png" alt="image-20240101191917287" style="zoom:50%;" />
    - 所有使用同一外地代理的移动主机都可以共享同一个转交地址<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101191958575.png" alt="image-20240101191958575" style="zoom:50%;" />
- 移动主机向固定主机发送IP数据报
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101193339754.png" alt="image-20240101193339754" style="zoom:50%;" />
    - IP数据报被移动主机A按照正常的发送流程发送出去即可
        由于IP路由器并不关心IP数据报的源地址因此该IP数据报被直接路由到固定主机B，而**无须再通过归属代理进行转发**
    - 为此，移动主机可以将**外地代理**作为自己的**默认路由器**，也可以通过代理发现协议从外地代理获取**外地网络中其他路由器**的地址，并将其设置为自己的**默认路由器**
    - **移动主机需要运行额外的外地代理软件**
        外地网络也需要提供相应机制，使移动主机能够自动获取一个外地网络中的地址作为自己的IP地址和外地代理的地址，被称为**同址转交地址**(Co-Located Careof Address)
- 三角形路由问题
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101194110634.png" alt="image-20240101194110634" style="zoom: 50%;" />





### IPv6

#### 引进的主要变化

诞生背景：

- IPv4是在20世纪70年代未期设计的，其IPv4地址的设计存在以下缺陷：
    - IPv4的设计者最初并没有想到该协议会在全球范围内广泛使用，因此将**IPv4地址的长度**规定为他们认为足够长的**32比特**。
    - IPv4地址**早期的编址方法**(分类的IPv4地址和划分子网的IPv4地址)也**不够合理**，**造成IPv4地址资源的浪费**
- 因特网经过几十年的飞速发展，**到2011年2月3日**，因特网号码分配管理局IANA宣布**IPv4地址**已经**分配完毕**因特网服务提供者ISP已经不能再申请到新的IPv4地址块。
    - 我国在2014至2015年也逐步停止向新用户和应用分配IPv4地址，同时全面开展商用部署IPv6.
- 如果没有**网络地址转换NAT技术**的广泛应用，IPv4早已停止发展
- 然而，NAT仅仅是为了延长IPv4使用寿命而采取的权宜之计，**解决IPv4地址耗尽的根本措施就是采用具有更大地址空间 (IP地址的长度为128比特)的新版本IP，即IPv6。**
- 因特网工程任务组IETF早在1992年6月就提出要制定下一代的IP，即iPng (IP Next Generation)。IPng现在正式称为IPv6。
- **直接将因特网的核心协议从IPv4更换成IPv6是不可行的.**
- 尽早过渡到IPv6有以下好处：
    - 有更多的时间来平滑过度
    - 有更多的时间来培养IPv6的专门人才
    - 及早提供IPv6服务比较便宜
- IPv6引进的主要变化
    - 更大的地址空间：IPv6将IPv4的**32比特**地址空间增大到了**128比特**，在采用合理编址方法的情况下，在可预见的未来是不会用完的。
    - 扩展的地址层次结构：可划分为更多的层次，这样可以更好地反映出因特网的拓扑结构，使得**对寻址和路由层次的设计更具有灵活性**
    - 灵活的首部格式：与IPv4首部并不兼容。IPv6定义了许多**可选的的扩展首部**，不仅可提供比IPv4更多的功能，而且还可以**提高路由器的处理效率**，因为路由器对逐跳扩展首部外的其他扩展首部都不进行处理。
    - 改进的选项：IPv6允许分组**包含有选项的控制信息**，因而**可以包含一些新的选项**。然而IPv4规定的选项却是固定不变的。
    - 允许协议继续扩充：**这一点很重要，因为技术总是在不断地发展，而新的应用也会层出不穷。然而IPv4的功能却是固定不变的。**
    - 支持即插即用(即自动配置)：IPv6支持主机或路由器自动配置IPv6地址及其他网络配置参数。因此**IPv6不需要使用DHCP（动态主机配置协议）
    - 支持资源的预分配：IPv6能为实时音视频等要求保证一定带宽和时延的应用，提供**更好的服务质量保证.**





#### IPv6数据报的首部

- 基本首部：
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101195532679.png" alt="image-20240101195532679" style="zoom:50%;" />![image-20240101195742826](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101195742826.png)
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101195742826.png" alt="image-20240101195742826" style="zoom:50%;" />
    - IPv6将IPv4数据报首部中不必要的功能取消了，这使得**IPv6数据报基本首部中的字段数量减少到只有8个**
        - 但由于IPv6地址的长度扩展到了128比特，因此使得**IPv6数据报基本首部的长度反而增大到了40字节**，比IPv4数据报首部固定部分的长度(20字节)增大了20字节
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101200019541.png" alt="image-20240101200019541" style="zoom:50%;" />
        - 版本字段:长度为4比特，用来表示IP协议的版本对于IPv6该字段的值是6
        - 通信量类字段:长度为8比特，该字段**用来区分不同的IPv6数据报的类别或优先级**。目前正在进行不同的通信量类性能的实验
        - 流标号字段:长度为20比特
            - IPv6提出了**流**的抽象概念
            - **“流”就是因特网上从特定源点到特定终点 (单播或多播)的一系列IPv6数据报 (如实时音视频数据的传送)，而在这个“流”所经过的路径上的所有路由器都保证指明的服务质量**
            - 所有属于同一个流的IPv6数据报都具有同样的流标号。换句话说，**流标号用于资源分配**
            - 流标号对于实时音视频数据的传送特别有用，但对于传统的非实时数据，流标号则没有用处，把流标号字段的值置为0即可。
        - 有效载荷长度字段: 长度为16比特，它**指明IPv6数据报基本首部后面的有效载荷 (包括扩展首部和数据部分)的字节数量**
            - 该字段以字节为单位，最大取值为65535，因此IPv6数据报基本首部后面的有效载荷的最大长度为65535字节
        - 下一个首部字段: 长度为8比特。该字段相当于IPv4数据报首部中的**协议字段或可选字段**
            - **当IPv6数据报没有扩展首部时**，该字段的作用与IPv4的协议字段一样，它的值指出了IPv6数据报基本首部后面的数据是何种协议数据单元PDU。
            - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101200509631.png" alt="image-20240101200509631" style="zoom:33%;" />
            - **当IPv6数据报基本首部后面带有扩展首部时**，该字段的值就标识后面第一个扩展首部的类型
        - 跳数限制字段: 长度为8比特。该字段用来**防止IPv6数据报在因特网中永久兜圈**
            - 源点在每个IPv6数据报发出时即设定某个跳数限制(最大255跳)
            - 每个路由器在转发IPv6数据报时，要先把跳数限制字段中的值减1。当跳数限制的值为0时，就把这个IPv6数据报丢弃(即不转发)。
            - 作用和TTL一样
- 拓展首部：
    - **IPv4数据报**如果在其首部中**使用了选项字段**，则在数据报的整个传送路径中的全部路由器，都要对选项字段进行检查，这就**降低了路由器处理数据报的速度。**
    - 实际上，在路径中的路由器对很多选项是不需要检查的。因此，**为了提高路由器对数据报的处理效率IPv6把原来IPv4首部中的选项字段都放在了扩展首部中**，由路径两端的源点和终点的主机来处理，而**数据报传送路径中的所有路由器都不处理这些扩展首部 (除逐跳选项扩展首部)。**







#### IPv6地址

IPv6空间大小：

- 在IPv6中，每个地址占**128个比特**
- IPv6地址空间大小为 $2^{128}$ (大于3.4x$10^{34}$)
    - 如果**整个地球表面** (包括陆地和水面)都覆盖着需要IPv6地址的通信设备，那么IPv6允许**每平方米拥有7 x $10^{23}$个IPv6地址**
    - 如果IPv6地址分配速率是**每微秒分配100万个IPv6地址**，则需要**$10^{19}$**年的时间才能将所有可能的地址分配完毕。
- 很显然，这样巨大的地址空间在**采用合理编址方法**的情况下，**在可预见的未来是不会用完的**





表示方式

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101201630510.png" alt="image-20240101201630510" style="zoom:50%;" />

- 在IPv6地址的冒号十六进制记法的基础上，再使用**“左侧零”省略**和**“连续零”压缩**，可使IPv6地址的表示**更加简洁**
    - “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0可以省略不写
    - “连续零”压缩是指一连串连续的0可以用一对冒号取代
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101201759316.png" alt="image-20240101201759316" style="zoom:50%;" />
    - **在一个IPv6地址中只能使用一次“连续零”压缩**，否则会导致歧义
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101201902515.png" alt="image-20240101201902515" style="zoom:50%;" />
    - **冒号十六进制记法还可结合点分十进制的后缀**。这在IPv4向IPv6过渡阶段非常有用
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101201957496.png" alt="image-20240101201957496" style="zoom:50%;" />

IPv6地址的分类

- IPv6数据报的目的地址有**三种基本类型**:
    - 单 播(unicast)：传统的点对点通信
    - 多播multicast：一点对多点的通信。数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，而将广播看作多播的一个特例。
    - 任 播(anycast)：这是IPv6新增的一种类型。**任播的终点是一组计算机，但数据报只交付其中的一个**，通常是按照路由算法得出的距离最近的一个
- [RFC 429]对IPv6地址进行了分类：
    - 未指明地址：
        - 128个比特为“全0”的地址，可缩写为两个冒号“.:”
        - 该地址不能用作目的地址，只能用于还没有配置到一个标准IPv6地址的主机用作源地址
        - 未指明地址仅有一个
    - 环回地址：
        - 最低比特为1，其余127个比特为“全0”，即0:0:0:0:0:0:0:1，可缩写为::1。
        - 该地址的作用与IPv4的环回地址相同
        - IPv6的环回地址只有一个
    - 多播地址：
        - 最高8比特为“全1”的地址，可记为FF00::/8
        - IPv6多播地址的功能与IPv4多播地址相同
        - 这类地址占IPv6地址空间的1/256。
    - 本地链路单播地址：
        - 最高10比特为1111111010的地址，可记为FE80::/10。
        - 即使用户网络没有连接到因特网，但仍然可以使用TCP/IP协议。连接在这种网络上的主机都可以使用本地链路单播地址进行通信，但不能和因特网上的其他主机通信。
        - 这类地址占IPv6地址空间的1/1024。
    - 全球单播地址：
        - 全球单播地址是使用得最多的一类地址
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101202944714.png" alt="image-20240101202944714" style="zoom:50%;" />







#### 从IPv4向IPv6过渡

因特网上使用IPv4的路由器的数量太大，要让所有路由器都改用IPv6并不能一蹴而就。因此，**从IPV4转变到IPv6只能采用逐步演进的办法**

另外，**新部署的IPv6系统必须能够向后兼容**，也就是IPv6系统必须能够接收和转发IPv4数据报，并且能够为IPv4数据报选择路由。

下面介绍两种由IPv4向IPv6过渡的策略:

- 使用双协议栈
    - 双协议栈(Dual Stack)是指在完全过渡到IPV6之前，使一部分主机或路由器**装有IPV4和IPv6两套协议栈。**
    - 双协议栈主机或路由器**既可以和IPv6系统通信，又可以和IPv4系统通信**
    - 双协议栈主机或路由器记为IPv6/IPv4，表明它**具有一个IPv6地址和一个IPv4地址**
        - 双协议栈主机在与IPv6主机通信时采用IPv6地址，而与IPv4主机通信时采用IPv4地址
        - 双协议栈主机通过域名系统DNS查询目的主机采用的IP地址:
            - 若DNS返回的是IPv4地址，则双协议栈的源主机就使用IPv4地址
            - 若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址
        - 例子，缺陷不可避免
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101204015545.png" alt="image-20240101204015545" style="zoom:50%;" />
- 使用隧道技术
    - 隧道技术(Tunneling)的核心思想是:
        - 当IPv6数据报要进入IPv4网络时，将IPv6数据报重新封装成IPv4数据报，即整个IPv6数据报成为IPv4数据报的数据载荷。
        - 封装有IPv6数据报的IPv4数据报在IPv4网络中传输
        - 当IPv4数据报要离开IPv4网络时，再将其数据荷(即原来的IPV6数据报)取出并转发到IP6网络
    - 例子
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101204727845.png" alt="image-20240101204727845" style="zoom:50%;" />







#### 网际控制报文ICMPv6

- 由于**IPv6**与IPv4一样，都**不确保数据报的可靠交付**，因此IPv6也需要**使用**网际控制报文协议**ICMP**来向发送IPv6数据报的源主机**反馈一些差错信息**，相应的ICMP版本为ICMPv6。
- **ICMPv6**比ICMPv4要复杂得多，它**合并了原来的地址解析协议ARP和网际组管理协议IGMP的功能**。因此与IPv6配套使用的网际层协议就只有ICMPv6这一个协议。
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101205048020.png" alt="image-20240101205048020" style="zoom:50%;" />
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101205132027.png" alt="image-20240101205132027" style="zoom:50%;" />
- ICMPv6报文可被用来报告差错、获取信息、探测邻站或管理多播通信
- 在对ICMPv6报文进行分类时，不同的RFC文档使用了不同的策略
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101205303125.png" alt="image-20240101205303125" style="zoom:50%;" />

## 运输层

### 运输层概述

#### 进程间基于网络的通信

第2~4章依次介绍了计算机网络体系结构中的物理层、数据链路层和网络层，它们共同解决了将主机通过异构网络互联起来所面临的问题，实现了**主机到主机的通信。**

然而在计算机网络中实际进行**通信的真正实体，是位于通信两端主机中的进程**

如何为**运行在不同主机上的应用进程提供直接的逻辑通信服务**，就是**运输层的主要任务**。运输层协议又称为端到端协议。

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101205624794.png" alt="image-20240101205624794" style="zoom:50%;" />

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101210302045.png" alt="image-20240101210302045" style="zoom:50%;" />

看似是使用一个”水平的信道连接两个主机的不同端口“，实际上是通过层层封装、运输、解封实现的





#### TCP/IP运输层中两个重要的协议

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101210926887.png" alt="image-20240101210926887" style="zoom:50%;" />

TCP：

- **传输控制协议** (Transmission Control Protocol，**TCP**)为其上层提供的是**面向连接**的**可靠**的数据传输服务
- 使用TCP通信的双方，在传送数据之前**必须首先建立TCP连接** (逻辑连接，而非物理连接)。数据传输结束后必须要**释放TCP连接。**（3次握手、四次挥手）
- TCP为了实现可靠传输，就必须使用很多措施，例如**TCP连接管理、确认机制、超时重传、流量控制以及拥塞控制等**
- TCP的**实现复杂**，，TCP报文段的**首部比较大**，**占用处理机资源比较多。**

UDP：

- **用户数据报协议** (User Datagram Protocol，**UDP**)，为其上层提供的是**无连接**的**不可靠**的数据传输服务。
- 使用UDP通信的双方，在传送数据之前**不需要建立连接。**
- UDP不需要实现可靠传输，因此**不需要使用实现可靠传输的各种机制。**
- UDP的**实现简单**，UDP用户数据报的**首部比较小**

典型使用：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101211932277.png" alt="image-20240101211932277" style="zoom:50%;" />





#### 运输层常见的概念

- 运输层端口号：运行在计算机上的进程是使用**进程标识符** (Process dentification，PID)来标识的。
    - 然而，因特网上的计算机并不是使用统一的操作系统，而**不同操作系统**(Windows、Linux、MacoS)又**使用不同格式的进程标识符。**
    - 为了使运行不同操作系统的计算机的应用进程之间能够基于网络进行通信，就必须**使用统一的方法对TCP/IP体系的应用进程进行标识**
    -  TCP/IP体系结构的运输层使用**端口号**来标识和区分应用层的不同应用进程。端口号的**长度为16比特，取值范围是0~65535**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101212813557.png" alt="image-20240101212813557" style="zoom:50%;" />
    - 端口号**只**和本机的进程有关系。
- 发送方的复用和接收方的分用：
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101213134918.png" alt="image-20240101213134918" style="zoom:50%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101214426995.png" alt="image-20240101214426995" style="zoom:50%;" />
    - 当用户访问一个网页时，先将DNS查询域名发送出去，然后再向Web服务器发送HTTP请求报文
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101213819417.png" alt="image-20240101213819417" style="zoom:50%;" />
        - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240101214227273.png" alt="image-20240101214227273" style="zoom:50%;" />











### UDP和TCP的对比



- 无连接的UDP和面向连接的TCP
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240104221041430.png" alt="image-20240104221041430" style="zoom:50%;" />
- 对单播，多播，广播的情况
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240104221139554.png" alt="image-20240104221139554" style="zoom:50%;" />
- 对应用层报文的处理
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105164015956.png" alt="image-20240105164015956" style="zoom:50%;" />
- 对数据传输可靠性的支持情况
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105164313998.png" alt="image-20240105164313998" style="zoom:50%;" />
- 首部对比
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105164420030.png" alt="image-20240105164420030" style="zoom:50%;" />





### TCP

#### TCP报文的首部格式

<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105173139053.png" alt="image-20240105173139053" style="zoom:50%;" />

- 序号：占32比特，取值范围0~$2^{32}-1$。当序号增加到最后一个时，下一个序号又回到0。**用来指出本TCP报文段数据载荷的第一个字节的序号。**
- 确认号：占32比特，取值范围0~$2^{32}-1$。当确认号增加到最后一个时，下一个确认号又回到0。**用来指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认。**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105174442705.png" alt="image-20240105174442705" style="zoom:50%;" />
        确认号301表示接收了300及以前的报文
        例题：<img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105175219649.png" alt="image-20240105175219649" style="zoom:50%;" />
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105182052758.png" alt="image-20240105182052758" style="zoom:50%;" />
        接收方的序号为发送过来的确认号，确认号为序号+有效载荷
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105194442445.png" alt="image-20240105194442445" style="zoom:50%;" />
- 数据偏移：
    - 占4比特，**该字段的取值以4字节为单位。**
    - 指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远这实际上**指出了TCP报文段的首部长度**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105194633196.png" alt="image-20240105194633196" style="zoom:50%;" />
- 保留：
    - 占6比特，保留以后使用
- 窗口字段：
    - 占16比特，**该字段的取值以字节为单位**
    - 指出发送本报文段的一方的**接收窗口的大小**，即接收缓存的可用空间大小，这用来表征接收方的**接收能力**
    - 在计算机网络中，经常**用接收方的接收能力的大小来控制发送方的数据发送量**，这就是所谓的**流量控制**
- 检验和：
    - 占16比特
    - 用来**检查整个TCP报文段在传输过程中是否出现了误码**
    - <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105195224234.png" alt="image-20240105195224234" style="zoom:50%;" />
- 同步标志位syn：
    - 用于TCP“三报文握手”**建立连接**
    - **当SYN=1且ACK=0时**，表明这是一个**TCP连接请求报文段**
    - 对方若**同意建立连接**，则应在**响应**的TCP报文段的首部中使**SYN=1且ACK=1.**
    - 综上所述，SYN为1的TCP报文段要么是一个连接请求报文段，要么是一个连接响应报文段。
- 终止标志位FIN：
    - 口用于TCP“四报文挥手”**释放连接**
    - 当FIN=1时，表明此TCP报文段的发送方已经将全部数据发送完毕，现在**要求释放TCP连接**
- 复位标志位RST ：
    - 用于**复位TCP连接**
    - 当**RST=1**时，表明**TCP连接中出现严重差错，必须释放连接，然后再重新建立连接**
    - RST置1还用来**拒绝一个非法的TCP报文段或拒绝打开一个TCP连接。**
- 推送标志位PSH：
    - 出于效率的考虑，TCP的发送方可能会延迟发送数据，而TCP的接收方可能会延迟向应用进程交付数据。这样可以一次处理更多的数据。
    - 但是当两个应用进程进行交互式通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应。在这种情况下，应用进程可以通知TCP使用推送 (PUSH) 操作
    - 发送方TCP把PSH置1，并立即创建一个TCP报文段发送出去，而不需要积累到足够多的数据再发送
    - 接收方TCP收到PSH为1的TCP报文段，就尽快地交付给应用进程而不再等到接收到足够多的数据才向上交付。
- 紧急标志位URG：
    - 当URG=1时，紧急指针字段有效
    - 当URG=0时，紧急指针字段无效
    - 占16比特，以字节为单位，用来指明紧急数据的长度。
    - 当**发送方有紧急数据**时，可将紧急数据“**插队**”到发送缓存的最前面，并立刻封装到一个TCP报文段中进行发送。**紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。**
    - **接收方收到紧急标志位为1的TCP报文段**，会按照紧急指针字段的值从报文段数据载芯中取出**紧急数据**并直接上交应用进程，而**不必在接收缓存中排队。**





#### 三报文握手建立TCP连接

- **TCP是面向连接**的协议，它基于运输连接来传送TCP报文段
    - TCP运输连接的建立和释放，**是每一次面向连接的通信中必不可少的过程**
- TCP运输连接有以下三个阶段:
    1. 通过“三报文握手”来建立TCP连接
    2. 基于已建立的TCP连接进行可靠的数据传输
    3. 在数据传输结束后，还要通过“四报文挥手”来释放TCP连接
    4. <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105231956618.png" alt="image-20240105231956618" style="zoom:50%;" />
- 存在的问题
    - 使TCP**双方能够确知对方的存在**
    - 使TCP双方能够**协商一些参数** (例如最大报文段长度、最大窗口大小、时间戳选项等)
    - 使TCP双方能够**对运输实体资源进行分配和初始化**。运输实体资源包括缓存大小、各状态变量、连接表中的项目等
- <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105232503796.png" alt="image-20240105232503796" style="zoom:50%;" />
    seq是序号，ack是确认报文的序号
- 例题1：
    <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105232914012.png" alt="image-20240105232914012" style="zoom:50%;" />
- 例题2：
    <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105233100121.png" alt="image-20240105233100121" style="zoom:50%;" />
- 采用三报文：
    <img src="%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/image-20240105233317645.png" alt="image-20240105233317645" style="zoom:50%;" />

